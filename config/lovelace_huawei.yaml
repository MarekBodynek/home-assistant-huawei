# Dashboard Huawei Solar - 3 kolumny PE≈ÅNA SZEROKO≈öƒÜ
# Sections view - nowy layout HA kt√≥ry u≈ºywa 100% szeroko≈õci ekranu
# COMMIT CHECK: b9e1bd2 - Test git pull

title: Huawei Solar PV
views:
  - title: PrzeglƒÖd
    icon: mdi:solar-power
    type: sections
    max_columns: 3
    sections:
      # SEKCJA 1 (lewa kolumna)
      - type: grid
        column_span: 1
        cards:
          # ZarzƒÖdzanie bateriƒÖ - tytu≈Ç + gauge + entities bez tytu≈Çu
          - type: vertical-stack
            title: ZarzƒÖdzanie bateriƒÖ
            cards:
              # Gauge'y baterii
              - type: horizontal-stack
                cards:
                  # Gauge SOC z kolorami sezonowymi (3 karty conditional)
                  - type: vertical-stack
                    cards:
                      # ZIMA (10-90%)
                      - type: conditional
                        conditions:
                          - condition: state
                            entity: sensor.bateria_limity_soc
                            state: "10-90%"
                        card:
                          type: gauge
                          entity: sensor.akumulatory_stan_pojemnosci
                          name: Stan Baterii
                          unit: "%"
                          min: 0
                          max: 100
                          needle: true
                          segments:
                            - from: 0
                              color: "#db4437"
                            - from: 10
                              color: "#43a047"
                            - from: 90
                              color: "#db4437"
                      # WIOSNA/JESIE≈É (15-85%)
                      - type: conditional
                        conditions:
                          - condition: state
                            entity: sensor.bateria_limity_soc
                            state: "15-85%"
                        card:
                          type: gauge
                          entity: sensor.akumulatory_stan_pojemnosci
                          name: Stan Baterii
                          unit: "%"
                          min: 0
                          max: 100
                          needle: true
                          segments:
                            - from: 0
                              color: "#db4437"
                            - from: 15
                              color: "#43a047"
                            - from: 85
                              color: "#db4437"
                      # LATO (20-80%)
                      - type: conditional
                        conditions:
                          - condition: state
                            entity: sensor.bateria_limity_soc
                            state: "20-80%"
                        card:
                          type: gauge
                          entity: sensor.akumulatory_stan_pojemnosci
                          name: Stan Baterii
                          unit: "%"
                          min: 0
                          max: 100
                          needle: true
                          segments:
                            - from: 0
                              color: "#db4437"
                            - from: 20
                              color: "#43a047"
                            - from: 80
                              color: "#db4437"
                  - type: gauge
                    entity: sensor.akumulatory_moc_ladowania_rozladowania
                    name: Moc Baterii
                    unit: "W"
                    min: -5000
                    max: 5000
                    needle: true
                    segments:
                      - from: -5000
                        color: "#db4437"
                      - from: -4000
                        color: "#ffa600"
                      - from: -2000
                        color: "#43a047"
                      - from: 2000
                        color: "#ffa600"
                      - from: 4000
                        color: "#db4437"
              # Entities bez tytu≈Çu
              - type: entities
                entities:
                  - entity: input_text.battery_decision_reason
                    name: üéØ Decyzja
                    icon: mdi:chart-line
                  - entity: input_number.battery_target_soc
                    name: üéØ Target SOC (obliczony o 04:00)
                  - entity: switch.akumulatory_ladowanie_z_sieci
                    name: ≈Åadowanie z sieci
                  - entity: sensor.akumulatory_status
                    name: Status baterii
                  - entity: sensor.bateria_temperatura_maksymalna
                    name: üå°Ô∏è Temperatura baterii (max)
                    icon: mdi:thermometer-high
                  - entity: select.akumulatory_tryb_pracy
                    name: ‚öôÔ∏è Tryb pracy
                state_color: true

          # Pompa ciep≈Ça - tytu≈Ç + gauge + entities bez tytu≈Çu
          - type: vertical-stack
            title: Pompa ciep≈Ça
            cards:
              # Gauge'y temperatury
              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.temperatura_co
                    name: Temp. zasilania
                    unit: "¬∞C"
                    min: 15
                    max: 65
                    needle: true
                    segments:
                      - from: 15
                        color: "#2196f3"
                      - from: 20
                        color: "#43a047"
                      - from: 35
                        color: "#ffa600"
                      - from: 50
                        color: "#db4437"
                  - type: vertical-stack
                    cards:
                      - type: gauge
                        entity: sensor.temperatura_cwu
                        name: Temp. CWU
                        unit: "¬∞C"
                        min: 30
                        max: 60
                        needle: true
                        segments:
                          - from: 30
                            color: "#2196f3"
                          - from: 47
                            color: "#43a047"
                          - from: 55
                            color: "#db4437"
                      - type: markdown
                        content: "<center>Cel: {{ state_attr('water_heater.bodynek_nb_tank', 'temperature') }}¬∞C</center>"
              # Status i encje bez tytu≈Çu
              - type: markdown
                content: |
                  {% set sezon = 'üü¢' if is_state('binary_sensor.sezon_grzewczy', 'on') else 'üî¥' %}
                  {% set co = 'üü¢' if is_state('binary_sensor.pc_co_aktywne', 'on') else 'üî¥' %}
                  {% set cwu = 'üü¢' if is_state('binary_sensor.cwu_aktywne', 'on') else 'üî¥' %}
                  {{ sezon }} Sezon Grzewczy ‚Ä¢ {{ co }} CO ‚Ä¢ {{ cwu }} CWU
              - type: entities
                entities:
                  - entity: switch.bodynek_nb_wymus_c_w_u
                    name: Wymu≈õ CWU
                state_color: true
              # Historia temperatury CWU
              - type: custom:apexcharts-card
                graph_span: 24h
                header:
                  show: false
                apex_config:
                  chart:
                    height: 150
                  yaxis:
                    min: 35
                    max: 60
                series:
                  - entity: sensor.temperatura_cwu
                    name: Temp. CWU
                    stroke_width: 2
                    color: "#ff9800"

      # SEKCJA 2 (≈õrodkowa kolumna)
      - type: grid
        column_span: 1
        cards:
          # Ceny RCE - tytu≈Ç + wykresy z kolorami + encje
          - type: vertical-stack
            title: Ceny RCE
            cards:
              # Wykres cen RCE - dzi≈õ (z kolorami przez fillColor)
              - type: custom:apexcharts-card
                header:
                  show: true
                  show_states: false
                graph_span: 24h
                span:
                  start: day
                apex_config:
                  title:
                    text: |
                      EVAL:(() => { const d = new Date(); return 'Ceny RCE (' + String(d.getDate()).padStart(2,'0') + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + d.getFullYear() + ')'; })()
                    align: left
                  chart:
                    height: 200
                  plotOptions:
                    bar:
                      distributed: true
                  legend:
                    show: false
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                    tickAmount: 12
                  yaxis:
                    min: 0
                    max: |
                      EVAL:function(max) { return Math.round((max + 0.1) * 100) / 100; }
                    tickAmount: 5
                    labels:
                      formatter: |
                        EVAL:function(val) { return val.toFixed(2); }
                  tooltip:
                    enabled: true
                    y:
                      formatter: |
                        EVAL:function(val) { return val.toFixed(3) + ' PLN/kWh'; }
                series:
                  - entity: sensor.rce_pse_cena
                    type: column
                    name: Cena
                    float_precision: 3
                    unit: PLN/kWh
                    data_generator: |
                      const prices = entity.attributes.prices || [];
                      const today = new Date().toISOString().split('T')[0];
                      const thresholds = hass.states['sensor.rce_progi_cenowe'];
                      const p33 = parseFloat(thresholds?.attributes?.p33) || 0.40;
                      const p66 = parseFloat(thresholds?.attributes?.p66) || 0.60;
                      function getColor(price) {
                        if (price < 0.20) return '#1b5e20';
                        if (price < p33) return '#4caf50';
                        if (price < p66) return '#ffeb3b';
                        return '#f44336';
                      }
                      const todayPrices = prices.filter(p => p.dtime && p.dtime.startsWith(today));
                      const hourly = {};
                      todayPrices.forEach(p => {
                        const hour = p.dtime.split(' ')[1].substring(0,2);
                        if (!hourly[hour]) hourly[hour] = [];
                        hourly[hour].push(p.rce_pln / 1000);
                      });
                      return Object.keys(hourly).sort().map(hour => {
                        const avg = hourly[hour].reduce((a,b) => a+b, 0) / hourly[hour].length;
                        const dt = new Date(today + 'T' + hour + ':00:00');
                        return { x: dt.getTime(), y: avg, fillColor: getColor(avg) };
                      });
              # Wykres cen RCE - jutro (z kolorami przez fillColor)
              - type: custom:apexcharts-card
                header:
                  show: true
                  show_states: false
                graph_span: 24h
                span:
                  start: day
                  offset: +1d
                apex_config:
                  title:
                    text: |
                      EVAL:(() => { const d = new Date(); d.setDate(d.getDate()+1); return 'Ceny RCE (' + String(d.getDate()).padStart(2,'0') + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + d.getFullYear() + ')'; })()
                    align: left
                  chart:
                    height: 200
                  plotOptions:
                    bar:
                      distributed: true
                  legend:
                    show: false
                  xaxis:
                    labels:
                      show: true
                      rotate: 0
                    tickAmount: 12
                  yaxis:
                    min: 0
                    max: |
                      EVAL:function(max) { return Math.round((max + 0.1) * 100) / 100; }
                    tickAmount: 5
                    labels:
                      formatter: |
                        EVAL:function(val) { return val.toFixed(2); }
                  tooltip:
                    enabled: true
                    y:
                      formatter: |
                        EVAL:function(val) { return val.toFixed(3) + ' PLN/kWh'; }
                series:
                  - entity: sensor.rce_pse_cena_jutro
                    type: column
                    name: Cena
                    float_precision: 3
                    unit: PLN/kWh
                    data_generator: |
                      const prices = entity.attributes.prices || [];
                      const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
                      const thresholds = hass.states['sensor.rce_progi_cenowe_jutro'];
                      const p33 = parseFloat(thresholds?.attributes?.p33) || 0.40;
                      const p66 = parseFloat(thresholds?.attributes?.p66) || 0.60;
                      function getColor(price) {
                        if (price < 0.20) return '#1b5e20';
                        if (price < p33) return '#4caf50';
                        if (price < p66) return '#ffeb3b';
                        return '#f44336';
                      }
                      const tomorrowPrices = prices.filter(p => p.dtime && p.dtime.startsWith(tomorrow));
                      const hourly = {};
                      tomorrowPrices.forEach(p => {
                        const hour = p.dtime.split(' ')[1].substring(0,2);
                        if (!hourly[hour]) hourly[hour] = [];
                        hourly[hour].push(p.rce_pln / 1000);
                      });
                      return Object.keys(hourly).sort().map(hour => {
                        const avg = hourly[hour].reduce((a,b) => a+b, 0) / hourly[hour].length;
                        const dt = new Date(tomorrow + 'T' + hour + ':00:00');
                        return { x: dt.getTime(), y: avg, fillColor: getColor(avg) };
                      });
              # Encje bez tytu≈Çu
              - type: entities
                entities:
                  - entity: sensor.strefa_taryfowa
                    name: Strefa taryfowa G12w
                    icon: mdi:clock-time-four-outline
                  - entity: sensor.cena_zakupu_energii
                    name: Cena obecna RCE
                    icon: mdi:cash
                  - entity: input_text.battery_cheapest_hours
                    name: RCE najta≈Ñsze godziny
                    icon: mdi:currency-usd

          # Pogoda i prognoza PV - tytu≈Ç + kafelek + encje
          - type: vertical-stack
            title: Pogoda i prognoza PV
            cards:
              - type: weather-forecast
                entity: weather.forecast_dom
                show_forecast: true
                forecast_type: hourly
                show_current: true
              - type: entities
                entities:
                  - entity: sensor.prognoza_pv_dzisiaj
                    name: Prognoza PV dzi≈õ
                    icon: mdi:solar-power
                  - entity: sensor.prognoza_pv_jutro
                    name: Prognoza PV jutro
                    icon: mdi:solar-power

      # SEKCJA 3 (prawa kolumna)
      - type: grid
        column_span: 1
        cards:
          # Produkcja energii - tytu≈Ç + gauge + entities + wykres bez tytu≈Çu
          - type: vertical-stack
            title: Produkcja energii
            cards:
              # Gauge'y PV
              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.inwerter_moc_wejsciowa
                    name: Produkcja PV
                    unit: "W"
                    min: 0
                    max: 12000
                    needle: true
                    segments:
                      - from: 0
                        color: "#43a047"
                      - from: 2000
                        color: "#ffa600"
                      - from: 7000
                        color: "#db4437"
                  - type: gauge
                    entity: sensor.nadwyzka_pv
                    name: Nadwy≈ºka PV
                    unit: "W"
                    min: 0
                    max: 12000
                    needle: true
                    segments:
                      - from: 0
                        color: "#43a047"
                      - from: 2000
                        color: "#ffa600"
                      - from: 5000
                        color: "#db4437"
              # Entities bez tytu≈Çu
              - type: entities
                entities:
                  - entity: sensor.produkcja_pv_godzinowa_dc
                    name: Produkcja PV w tej godzinie
                    icon: mdi:clock-outline
                  - entity: sensor.produkcja_pv_dzienna_rzeczywista
                    name: Dzienna produkcja PV
                    icon: mdi:weather-sunny
              # Gauge'y zu≈ºycia
              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.zuzycie_domu_moc
                    name: Zu≈ºycie domu
                    unit: "W"
                    min: 0
                    max: 10000
                    needle: true
                    segments:
                      - from: 0
                        color: "#43a047"
                      - from: 2000
                        color: "#ffa600"
                      - from: 5000
                        color: "#db4437"
                  - type: gauge
                    entity: sensor.pomiar_mocy_moc_czynna
                    name: Sieƒá
                    unit: "W"
                    min: -10000
                    max: 10000
                    needle: true
                    segments:
                      - from: -10000
                        color: "#db4437"
                      - from: -5000
                        color: "#ffa600"
                      - from: -2000
                        color: "#43a047"
                      - from: 2000
                        color: "#ffa600"
                      - from: 5000
                        color: "#db4437"
              # Historia mocy bez tytu≈Çu
              - type: history-graph
                hours_to_show: 24
                entities:
                  - entity: sensor.zuzycie_domu_moc
                    name: Zu≈ºycie domu
                  - entity: sensor.inwerter_moc_czynna
                    name: Moc wyj≈õciowa
                  - entity: sensor.akumulatory_moc_ladowania_rozladowania
                    name: Bateria
                  - entity: sensor.pomiar_mocy_moc_czynna
                    name: Sieƒá

  - title: Statystyki
    icon: mdi:chart-bar
    cards:
      - type: statistics-graph
        title: Bateria - ostatni tydzie≈Ñ
        stat_types:
          - mean
          - min
          - max
        entities:
          - sensor.akumulatory_stan_pojemnosci
        days_to_show: 7

      - type: statistics-graph
        title: Produkcja dzienna
        stat_types:
          - sum
        entities:
          - sensor.inwerter_dzienna_produkcja
        days_to_show: 30
        chart_type: bar
