# ============================================
# AUTOMATYZACJE ALGORYTMU ZARZÄ„DZANIA BATERIÄ„
# Zgodne z harmonogramem z ALGORITHM.md
# ============================================

# ============================================
# 00:00 - Oblicz strategiÄ™ dziennÄ…
# ============================================

- id: battery_calculate_daily_strategy
  alias: "[Bateria] Oblicz strategiÄ™ dziennÄ… 00:00"
  description: "Oblicza cel Å‚adowania (Target SOC) na podstawie prognozy PV i temperatury"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: python_script.calculate_daily_strategy
  mode: single

# ============================================
# CO 1 GODZINÄ˜ - Wykonaj strategiÄ™ (gÅ‚Ã³wna pÄ™tla)
# ============================================

- id: battery_execute_strategy_hourly
  alias: "[Bateria] Wykonaj strategiÄ™ (co 1h)"
  description: "GÅ‚Ã³wna pÄ™tla algorytmu - wykonywana co godzinÄ™"
  trigger:
    - platform: time_pattern
      hours: "*"
      minutes: "00"
  action:
    - service: python_script.battery_algorithm
  mode: single

# ============================================
# KLUCZOWE MOMENTY - Dodatkowe wykonanie strategii
# ============================================

- id: battery_execute_strategy_key_moments
  alias: "[Bateria] Wykonaj strategiÄ™ (kluczowe momenty)"
  description: "Dodatkowe wykonanie przy zmianach stref taryfowych"
  trigger:
    # PoczÄ…tek okna CWU rano
    - platform: time
      at: "04:30:00"
    # Zmiana L2 â†’ L1 rano
    - platform: time
      at: "06:00:00"
    # Zmiana L1 â†’ L2 poÅ‚udnie
    - platform: time
      at: "13:00:00"
    # Zmiana L2 â†’ L1 poÅ‚udnie
    - platform: time
      at: "15:00:00"
    # SZCZYT wieczorny + arbitraÅ¼
    - platform: time
      at: "19:00:00"
    # Zmiana L1 â†’ L2 wieczÃ³r + Å‚adowanie
    - platform: time
      at: "22:00:00"
  action:
    - service: python_script.battery_algorithm
  mode: single

# ============================================
# MONITOROWANIE KRYTYCZNE (co 1 minutÄ™)
# ============================================

- id: battery_monitor_critical_soc
  alias: "[Bateria] Monitor SOC krytyczne"
  description: "Monitoruje SOC i reaguje na krytyczne wartoÅ›ci (limit Huawei 20%)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      below: 22
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸš¨ BATERIA KRYTYCZNIE NISKA!"
        message: "SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}% - wymuszam Å‚adowanie!"
    - service: python_script.battery_algorithm
  mode: single

- id: battery_monitor_critical_soc_l1
  alias: "[Bateria] Monitor SOC niskie w L1"
  description: "OstrzeÅ¼enie gdy SOC niskie w drogie strefie L1"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      below: 20
  condition:
    - condition: state
      entity_id: sensor.strefa_taryfowa
      state: "L1"
  action:
    - service: persistent_notification.create
      data:
        title: "âš ï¸ Bateria niska w L1"
        message: "SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}% w drogie strefie L1!"
  mode: single

- id: battery_monitor_soc_max
  alias: "[Bateria] Monitor SOC maksymalne"
  description: "Zatrzymuje Å‚adowanie gdy SOC osiÄ…gnie 78% (blisko limitu Huawei 80%)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      above: 78
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.akumulatory_ladowanie_z_sieci
    - service: persistent_notification.create
      data:
        title: "âœ… Bateria naÅ‚adowana"
        message: "SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}% - zatrzymano Å‚adowanie"
  mode: single

# ============================================
# POBIERANIE PROGNOZ
# ============================================

- id: battery_update_forecast_morning
  alias: "[Bateria] Aktualizuj prognozÄ™ PV (04:00)"
  description: "Pobiera prognozÄ™ PV rano przed obliczeniem strategii"
  trigger:
    - platform: time
      at: "03:55:00"
  action:
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.energy_production_today
          - sensor.energy_production_tomorrow
  mode: single

- id: battery_update_forecast_noon
  alias: "[Bateria] Aktualizuj prognozÄ™ PV (12:00)"
  description: "Pobiera prognozÄ™ PV w poÅ‚udnie"
  trigger:
    - platform: time
      at: "12:00:00"
  action:
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.energy_production_today
          - sensor.energy_production_tomorrow
  mode: single

- id: battery_update_forecast_evening
  alias: "[Bateria] Aktualizuj prognozÄ™ PV (20:00)"
  description: "Pobiera prognozÄ™ PV wieczorem"
  trigger:
    - platform: time
      at: "20:00:00"
  action:
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.energy_production_today
          - sensor.energy_production_tomorrow
  mode: single

# ============================================
# POBIERANIE CEN RCE
# ============================================

- id: battery_fetch_rce_prices
  alias: "[Bateria] Pobierz ceny RCE (18:00)"
  description: "Pobiera ceny RCE z Pstryk o 18:00 z losowym opÃ³Åºnieniem"
  trigger:
    - platform: time
      at: "18:00:00"
  action:
    # Losowe opÃ³Åºnienie 0-15 min
    - delay:
        seconds: "{{ range(0, 900) | random }}"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.pstryk_current_buy_price
          - sensor.pstryk_current_sell_price
  mode: single

# ============================================
# BEZPIECZEÅƒSTWO TERMICZNE BATERII
# ============================================

- id: battery_temperature_warning
  alias: "[Bateria] ğŸŸ  Temperatura wysoka (>40Â°C)"
  description: "OstrzeÅ¼enie o podwyÅ¼szonej temperaturze baterii (przyspieszona degradacja)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      above: 40
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸŸ  OSTRZEÅ»ENIE: Temperatura baterii wysoka!"
        message: |
          âš ï¸ Temperatura baterii: {{ states('sensor.akumulator_1_temperatura') }}Â°C

          **DziaÅ‚ania:**
          - Zredukowano intensywnoÅ›Ä‡ Å‚adowania
          - Monitoruj temperaturÄ™ przez kolejne 30 min

          **Przyczyny:**
          - Intensywne Å‚adowanie/rozÅ‚adowanie
          - Wysoka temperatura otoczenia
          - SÅ‚aba wentylacja pomieszczenia

          **Bezpieczny zakres:** 15-40Â°C
        notification_id: battery_temp_warning
  mode: single

- id: battery_temperature_critical_stop_charging
  alias: "[Bateria] ğŸ”´ KRYTYCZNE: Temperatura >43Â°C - STOP Å‚adowania!"
  description: "Zatrzymuje Å‚adowanie baterii przy temperaturze >43Â°C (ochrona przed uszkodzeniem)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      above: 43
  action:
    # NATYCHMIAST wyÅ‚Ä…cz Å‚adowanie z sieci
    - service: switch.turn_off
      target:
        entity_id: switch.akumulatory_ladowanie_z_sieci
    # Ustaw tryb bezpieczny (tylko autoconsumption, bez intensywnego Å‚adowania)
    - service: select.select_option
      target:
        entity_id: select.akumulatory_tryb_pracy
      data:
        option: "maximise_self_consumption"
    # ALARM!
    - service: persistent_notification.create
      data:
        title: "ğŸ”´ğŸš¨ ALARM: Temperatura baterii KRYTYCZNA!"
        message: |
          ğŸ”¥ TEMPERATURA BATERII: {{ states('sensor.akumulator_1_temperatura') }}Â°C

          âš ï¸ PRZEKROCZONO BEZPIECZNY PRÃ“G (43Â°C)!

          **WYKONANO AUTOMATYCZNIE:**
          âœ… Zatrzymano Å‚adowanie z sieci
          âœ… Ustawiono tryb bezpieczny (Maximise Self Consumption)

          **CO ZROBIÄ†:**
          1. SprawdÅº temperaturÄ™ pomieszczenia z bateriÄ…
          2. Zapewnij lepszÄ… wentylacjÄ™
          3. NIE WZNAWIAJ Å‚adowania dopÃ³ki temp < 35Â°C
          4. RozwaÅ¼ kontakt z serwisem Huawei

          **LIMIT BEZPIECZEÅƒSTWA:** >45Â°C = ryzyko poÅ¼aru!
        notification_id: battery_temp_critical
  mode: single

- id: battery_temperature_extreme_alarm
  alias: "[Bateria] âš« EKSTREMALNIE NIEBEZPIECZNE: Temperatura >45Â°C!"
  description: "Alarm ekstremalny - potencjalne zagroÅ¼enie poÅ¼arem"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      above: 45
  action:
    # Wszystkie moÅ¼liwe wyÅ‚Ä…czenia
    - service: switch.turn_off
      target:
        entity_id: switch.akumulatory_ladowanie_z_sieci
    - service: select.select_option
      target:
        entity_id: select.akumulatory_tryb_pracy
      data:
        option: "maximise_self_consumption"
    # EKSTREMALNY ALARM
    - service: persistent_notification.create
      data:
        title: "âš«ğŸš¨ğŸ”¥ EKSTREMALNIE NIEBEZPIECZNE: BATERIA PRZEGRZANA!"
        message: |
          ğŸ”¥ğŸ”¥ğŸ”¥ TEMPERATURA: {{ states('sensor.akumulator_1_temperatura') }}Â°C ğŸ”¥ğŸ”¥ğŸ”¥

          âš« PRZEKROCZONO EKSTREMALNY PRÃ“G (45Â°C)!
          âš ï¸ RYZYKO POÅ»ARU/USZKODZENIA BATERII!

          **NATYCHMIASTOWE DZIAÅANIA:**
          1. âŒ ODÅÄ„CZ bateriÄ™ od systemu (wyÅ‚Ä…cznik awaryjny)
          2. ğŸš’ Przygotuj gaÅ›nicÄ™ (NIE WODNÄ„ - tylko CO2/proszek ABC)
          3. ğŸƒ Ewakuuj pomieszczenie
          4. ğŸ“ ZadzwoÅ„ do serwisu Huawei NATYCHMIAST
          5. ğŸ“ W razie oznak dymu/ognia: 998 (straÅ¼ poÅ¼arna)

          **NIE IGNORUJ TEGO ALARMU!**
        notification_id: battery_temp_extreme

- id: battery_temperature_freezing
  alias: "[Bateria] â„ï¸ Temperatura poniÅ¼ej 0Â°C - mrÃ³z!"
  description: "OstrzeÅ¼enie o niskiej temperaturze (moÅ¼liwe uszkodzenie ogniw)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      below: 0
  action:
    # WyÅ‚Ä…cz Å‚adowanie przy mrozie
    - service: switch.turn_off
      target:
        entity_id: switch.akumulatory_ladowanie_z_sieci
    - service: persistent_notification.create
      data:
        title: "â„ï¸ OSTRZEÅ»ENIE: Bateria zamarza!"
        message: |
          ğŸ¥¶ Temperatura baterii: {{ states('sensor.akumulator_1_temperatura') }}Â°C

          âš ï¸ TEMPERATURA PONIÅ»EJ 0Â°C!

          **Ryzyko:**
          - Uszkodzenie ogniw litowych
          - TrwaÅ‚a utrata pojemnoÅ›ci
          - SkrÃ³cenie Å¼ywotnoÅ›ci baterii

          **DziaÅ‚ania:**
          âœ… Zatrzymano Å‚adowanie z sieci

          **Co zrobiÄ‡:**
          1. Ogrzej pomieszczenie z bateriÄ… do min. 10Â°C
          2. Poczekaj aÅ¼ bateria siÄ™ ogrzeje
          3. NIE Å‚aduj przy temp < 5Â°C

          **Bezpieczny zakres:** 0-40Â°C (optymalnie 15-25Â°C)
        notification_id: battery_temp_freezing
  mode: single

- id: battery_temperature_normal_resumed
  alias: "[Bateria] âœ… Temperatura baterii wrÃ³ciÅ‚a do normy"
  description: "Informacja o powrocie do bezpiecznej temperatury"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      below: 38
      for:
        minutes: 15
  condition:
    # Tylko jeÅ›li wczeÅ›niej byÅ‚a wysoka
    - condition: numeric_state
      entity_id: sensor.akumulator_1_temperatura
      below: 38
  action:
    - service: persistent_notification.create
      data:
        title: "âœ… Temperatura baterii bezpieczna"
        message: |
          ğŸŸ¢ Temperatura baterii: {{ states('sensor.akumulator_1_temperatura') }}Â°C

          Temperatura wrÃ³ciÅ‚a do bezpiecznego zakresu.
          Algorytm zarzÄ…dzania bateriÄ… moÅ¼e dziaÅ‚aÄ‡ normalnie.

          **Bezpieczny zakres:** 15-40Â°C
        notification_id: battery_temp_normal
    # UsuÅ„ stare alerty
    - service: persistent_notification.dismiss
      data:
        notification_id: battery_temp_warning
    - service: persistent_notification.dismiss
      data:
        notification_id: battery_temp_critical
  mode: single

# ============================================
# WATCHDOG - MONITOROWANIE PRACY ALGORYTMU
# ============================================

- id: battery_watchdog_algorithm_health
  alias: "[Bateria] Watchdog - sprawdzenie zdrowia algorytmu"
  description: "Monitoruje czy algorytm baterii dziaÅ‚a prawidÅ‚owo (sprawdza aktualizacjÄ™ decision_reason)"
  trigger:
    - platform: time_pattern
      hours: "*"
      minutes: "30"
  condition:
    # SprawdÅº czy decision_reason nie zostaÅ‚ zaktualizowany przez 2h
    - condition: template
      value_template: >
        {% set last_changed = states.input_text.battery_decision_reason.last_changed %}
        {% set now = now() %}
        {{ (now - last_changed).total_seconds() > 7200 }}
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸš¨ WATCHDOG: Algorytm baterii nie dziaÅ‚a!"
        message: |
          âš ï¸ Algorytm baterii nie aktualizowaÅ‚ decyzji przez >2h!

          Ostatnia aktualizacja: {{ states.input_text.battery_decision_reason.last_changed }}
          Obecny SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          Strefa: {{ states('sensor.strefa_taryfowa') }}

          ğŸ”§ SprawdÅº logi Home Assistant i poprawnoÅ›Ä‡ konfiguracji!
        notification_id: battery_watchdog_alert
    # Ustaw tryb awaryjny - Maximise Self Consumption (bezpieczny fallback)
    - service: select.select_option
      target:
        entity_id: select.akumulatory_tryb_pracy
      data:
        option: "maximise_self_consumption"
    - service: switch.turn_off
      target:
        entity_id: switch.akumulatory_ladowanie_z_sieci
  mode: single

- id: battery_watchdog_soc_stuck
  alias: "[Bateria] Watchdog - SOC nie zmienia siÄ™"
  description: "OstrzeÅ¼enie gdy SOC nie zmienia siÄ™ przez 6h (moÅ¼liwa awaria baterii/inwertera)"
  trigger:
    - platform: state
      entity_id: sensor.akumulatory_stan_pojemnosci
      for:
        hours: 6
  action:
    - service: persistent_notification.create
      data:
        title: "âš ï¸ WATCHDOG: SOC baterii nie zmienia siÄ™!"
        message: |
          Bateria utrzymuje staÅ‚y SOC {{ states('sensor.akumulatory_stan_pojemnosci') }}% przez >6h

          MoÅ¼liwe przyczyny:
          - Awaria komunikacji z bateriÄ…
          - Zablokowany tryb pracy
          - Problem z inwerterem

          SprawdÅº fizyczne poÅ‚Ä…czenie i stan urzÄ…dzeÅ„!
        notification_id: battery_soc_stuck_alert
  mode: single

# ============================================
# POWIADOMIENIA DZIENNE
# ============================================

- id: battery_daily_summary
  alias: "[Bateria] Podsumowanie dzienne (23:00)"
  description: "WysyÅ‚a podsumowanie dnia o 23:00"
  trigger:
    - platform: time
      at: "23:00:00"
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ“Š Podsumowanie dnia - Bateria"
        message: |
          **Bateria:**
          - Obecny SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Target SOC jutro: {{ states('input_number.battery_target_soc') }}%

          **Produkcja PV:**
          - DziÅ›: {{ states('sensor.inwerter_dzienna_produkcja') }} kWh
          - Prognoza jutro: {{ states('sensor.prognoza_pv_jutro') }} kWh

          **Ceny:**
          - Cena kupna: {{ states('sensor.pstryk_current_buy_price') }} zÅ‚/kWh
          - Cena sprzedaÅ¼y: {{ states('sensor.pstryk_current_sell_price') }} zÅ‚/kWh

          **Pogoda jutro:**
          - Temp: {{ state_attr('weather.forecast_dom', 'temperature') }}Â°C
          - Sezon grzewczy: {{ states('binary_sensor.sezon_grzewczy') }}
  mode: single
