# Home Assistant - Konfiguracja dla Huawei Solar
# Dokumentacja: https://www.home-assistant.io/docs/configuration/

# Podstawowa konfiguracja
homeassistant:
  name: Dom
  latitude: 52.2297
  longitude: 21.0122
  elevation: 100
  unit_system: metric
  time_zone: Europe/Warsaw
  currency: PLN
  external_url: https://ha.bodino.us.kg
  internal_url: http://192.168.0.106:8123

# Frontend
frontend:
  themes: !include_dir_merge_named themes

# Dashboardy
lovelace:
  mode: storage
  dashboards:
    lovelace-huawei:
      mode: yaml
      title: Huawei Solar PV
      icon: mdi:solar-power
      show_in_sidebar: true
      filename: lovelace_huawei.yaml
  resources:
    - url: /local/community/apexcharts-card/apexcharts-card.js
      type: module

# Logowanie
logger: !include logger.yaml

# Historia
history:

# Logbook
logbook:

# Rekorder - przechowywanie danych
recorder:
  purge_keep_days: 30
  db_url: sqlite:////config/home-assistant_v2.db

# Energia
energy:

# Aplikacja mobilna
mobile_app:

# Template sensors
template: !include template_sensors.yaml

# Input numbers
input_number: !include input_numbers.yaml

# Input text
input_text: !include input_text.yaml

# Python Scripts
python_script:

# Automatyzacje
automation manual: !include automations.yaml
automation battery: !include automations_battery.yaml
automation errors: !include automations_errors.yaml

# Skrypty
script: !include scripts.yaml

# Sceny
scene: !include scenes.yaml

# Shell commands
shell_command:
  git_pull: 'cd /config && git pull'
  git_pull_verbose: 'cd /config && git pull origin main > /config/git_pull.log 2>&1 && echo "SUCCESS" >> /config/git_pull.log || echo "FAILED: $?" >> /config/git_pull.log'
  git_status: 'cd /config && git status > /config/git_status.log 2>&1'
  copy_logs_to_www: 'mkdir -p /config/www && cp /config/git_pull.log /config/www/git_pull.log 2>/dev/null; cp /config/git_status.log /config/www/git_status.log 2>/dev/null; head -50 /config/lovelace_huawei.yaml > /config/www/lovelace_check.txt 2>&1'

# Time & Date sensors
sensor:
  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - 'date_time'

# Forecast Solar - REST API dla 3 płaszczyzn
# scan_interval: 7200s (2h) = optymalizacja zapytań (-50% vs 1h)
rest:
  - resource: https://api.forecast.solar/estimate/watts/52.2297/21.0122/30/90/8.1
    scan_interval: 7200
    sensor:
      - name: "PV Wschód - Prognoza dziś"
        unique_id: forecast_solar_wschod_today
        value_template: >
          {% set today = now().date() | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[today] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"
        json_attributes_path: "$.result"
        json_attributes:
          - "watt_hours_day"
          - "watts"
      - name: "PV Wschód - Prognoza jutro"
        unique_id: forecast_solar_wschod_tomorrow
        value_template: >
          {% set tomorrow = (now().date() + timedelta(days=1)) | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[tomorrow] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"

  - resource: https://api.forecast.solar/estimate/watts/52.2297/21.0122/30/180/4.05
    scan_interval: 7200
    sensor:
      - name: "PV Południe - Prognoza dziś"
        unique_id: forecast_solar_poludnie_today
        value_template: >
          {% set today = now().date() | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[today] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"
        json_attributes_path: "$.result"
        json_attributes:
          - "watt_hours_day"
          - "watts"
      - name: "PV Południe - Prognoza jutro"
        unique_id: forecast_solar_poludnie_tomorrow
        value_template: >
          {% set tomorrow = (now().date() + timedelta(days=1)) | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[tomorrow] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"

  - resource: https://api.forecast.solar/estimate/watts/52.2297/21.0122/30/270/4.05
    scan_interval: 7200
    sensor:
      - name: "PV Zachód - Prognoza dziś"
        unique_id: forecast_solar_zachod_today
        value_template: >
          {% set today = now().date() | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[today] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"
        json_attributes_path: "$.result"
        json_attributes:
          - "watt_hours_day"
          - "watts"
      - name: "PV Zachód - Prognoza jutro"
        unique_id: forecast_solar_zachod_tomorrow
        value_template: >
          {% set tomorrow = (now().date() + timedelta(days=1)) | string %}
          {% set data = value_json.result.watt_hours_day %}
          {{ data[tomorrow] | float(0) / 1000 | round(1) }}
        unit_of_measurement: "kWh"

# Binary sensor - Dzień roboczy (wykrywa święta i weekendy)
binary_sensor:
  - platform: workday
    name: Dzień roboczy
    country: PL
    workdays: [mon, tue, wed, thu, fri]
    excludes: [sat, sun, holiday]
    add_holidays:
      # 2025
      - '2025-01-01'  # Nowy Rok
      - '2025-01-06'  # Trzech Króli
      - '2025-04-20'  # Wielkanoc
      - '2025-04-21'  # Poniedziałek Wielkanocny
      - '2025-05-01'  # Święto Pracy
      - '2025-05-03'  # Święto Konstytucji 3 Maja
      - '2025-06-19'  # Boże Ciało
      - '2025-08-15'  # Wniebowzięcie NMP
      - '2025-11-01'  # Wszystkich Świętych
      - '2025-11-11'  # Święto Niepodległości
      - '2025-12-25'  # Boże Narodzenie
      - '2025-12-26'  # Drugi dzień Bożego Narodzenia
      # 2026
      - '2026-01-01'
      - '2026-01-06'
      - '2026-04-05'  # Wielkanoc
      - '2026-04-06'  # Poniedziałek Wielkanocny
      - '2026-05-01'
      - '2026-05-03'
      - '2026-05-28'  # Boże Ciało
      - '2026-08-15'
      - '2026-11-01'
      - '2026-11-11'
      - '2026-12-25'
      - '2026-12-26'
      # 2027
      - '2027-01-01'
      - '2027-01-06'
      - '2027-03-28'  # Wielkanoc
      - '2027-03-29'  # Poniedziałek Wielkanocny
      - '2027-05-01'
      - '2027-05-03'
      - '2027-06-10'  # Boże Ciało
      - '2027-08-15'
      - '2027-11-01'
      - '2027-11-11'
      - '2027-12-25'
      - '2027-12-26'

# HTTP
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
    - ::1
    - 172.30.33.0/24  # Cloudflare Tunnel addon
    - 172.16.0.0/12   # Docker networks (covers 172.16-172.31)
    - 173.245.48.0/20
    - 103.21.244.0/22
    - 103.22.200.0/22
    - 103.31.4.0/22
    - 141.101.64.0/18
    - 108.162.192.0/18
    - 190.93.240.0/20
    - 188.114.96.0/20
    - 197.234.240.0/22
    - 198.41.128.0/17
    - 162.158.0.0/15
    - 104.16.0.0/13
    - 104.24.0.0/14
    - 172.64.0.0/13
    - 131.0.72.0/22
