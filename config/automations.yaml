# Automatyzacje dla systemu Huawei Solar z bateriƒÖ Luna 2000
# Tryb: PV PRIORITY - priorytet ≈Çadowania z fotowoltaiki

# ===================================================================
# AUTOMATYKA 1: W≈ÇƒÖczenie ≈Çadowania w najta≈Ñszych godzinach (taryfa nocna)
# ===================================================================
- id: huawei_cheap_charging_start
  alias: "Huawei - ≈Åadowanie w taniej taryfie"
  description: "W≈ÇƒÖcza priorytet ≈Çadowania baterii z sieci w godzinach taniej energii"
  trigger:
    # Taryfa nocna G12 - dostosuj godziny do swojej taryfy
    - platform: time
      at: "22:00:00"
  condition:
    # Warunek: bateria poni≈ºej 80% (dostosuj pr√≥g wed≈Çug potrzeb)
    - condition: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      below: 80
  action:
    # Ustaw tryb pracy na "Time of Use" z priorytetem ≈Çadowania
    - service: huawei_solar.set_tou_periods
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
        periods:
          - start_time: "22:00"
            end_time: "06:00"
            charge_flag: 1  # 1 = ≈Çadowanie dozwolone
            days_effective: [1,2,3,4,5,6,7]  # wszystkie dni tygodnia
    - service: notify.persistent_notification
      data:
        title: "‚ö° Huawei Solar"
        message: "W≈ÇƒÖczono ≈Çadowanie baterii w taniej taryfie ({{ now().strftime('%H:%M') }})"

# ===================================================================
# AUTOMATYKA 2: Przerwanie ≈Çadowania po osiƒÖgniƒôciu 90%
# ===================================================================
- id: huawei_stop_charging_high_soc
  alias: "Huawei - Stop ≈Çadowania przy 90%"
  description: "Zatrzymuje ≈Çadowanie z sieci gdy bateria osiƒÖgnie 90%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      above: 90
  condition:
    # Warunek: trwa taryfa nocna
    - condition: time
      after: "22:00:00"
      before: "06:00:00"
  action:
    - service: huawei_solar.set_tou_periods
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
        periods:
          - start_time: "22:00"
            end_time: "06:00"
            charge_flag: 0  # 0 = ≈Çadowanie wstrzymane
            days_effective: [1,2,3,4,5,6,7]
    - service: notify.persistent_notification
      data:
        title: "‚úÖ Huawei Solar"
        message: "Bateria na≈Çadowana do {{ states('sensor.akumulatory_stan_pojemnosci') }}%, stop ≈Çadowania"

# ===================================================================
# AUTOMATYKA 3: Powr√≥t do trybu PV Priority po zako≈Ñczeniu taniej taryfy
# ===================================================================
- id: huawei_pv_priority_mode
  alias: "Huawei - Tryb PV Priority (dzie≈Ñ)"
  description: "Prze≈ÇƒÖcza na priorytet ≈Çadowania z PV w ciƒÖgu dnia"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    # Przywr√≥cenie trybu PV Priority
    - service: huawei_solar.set_tou_periods
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
        periods:
          - start_time: "06:00"
            end_time: "22:00"
            charge_flag: 2  # 2 = tylko z PV (priorytet fotowoltaiki)
            days_effective: [1,2,3,4,5,6,7]
    - service: notify.persistent_notification
      data:
        title: "‚òÄÔ∏è Huawei Solar"
        message: "Prze≈ÇƒÖczono na tryb PV PRIORITY ({{ now().strftime('%H:%M') }})"

# ===================================================================
# AUTOMATYKA 4: Awaryjne ≈Çadowanie przy krytycznie niskim stanie baterii
# ===================================================================
- id: huawei_emergency_charging
  alias: "Huawei - Awaryjne ≈Çadowanie (SOC<15%)"
  description: "W≈ÇƒÖcza ≈Çadowanie z sieci gdy bateria poni≈ºej 15%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.akumulatory_stan_pojemnosci
      below: 15
  action:
    - service: huawei_solar.forcible_charge
      data:
        device_id: 7aa193fa5ec07dc7da9f5034f97e6987  # Connected Energy Storage (bateria)
        power: 5000  # Moc ≈Çadowania w W (dla Luna 2000 15kWh max 5kW)
        duration: 120  # Czas w minutach
    - service: notify.persistent_notification
      data:
        title: "‚ö†Ô∏è Huawei Solar - Alarm"
        message: "Niski stan baterii ({{ states('sensor.akumulatory_stan_pojemnosci') }}%)! Rozpoczƒôto awaryjne ≈Çadowanie."

# ===================================================================
# AUTOMATYKA 5: Optymalizacja wed≈Çug prognozy pogody
# ===================================================================
- id: huawei_weather_optimization
  alias: "Huawei - Optymalizacja wed≈Çug pogody"
  description: "Zwiƒôksza ≈Çadowanie nocƒÖ je≈õli prognozowane sƒÖ chmury"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    # Sprawd≈∫ prognozƒô na jutro (wymaga integracji pogody)
    - condition: or
      conditions:
        - condition: state
          entity_id: weather.forecast_dom
          state: 'cloudy'
        - condition: state
          entity_id: weather.forecast_dom
          state: 'rainy'
  action:
    # Za≈Çaduj bateriƒô do wy≈ºszego poziomu przed dniem z ma≈ÇƒÖ produkcjƒÖ PV
    - service: huawei_solar.forcible_charge
      data:
        device_id: 7aa193fa5ec07dc7da9f5034f97e6987  # Connected Energy Storage (bateria)
        power: 3000
        duration: 480  # 8 godzin
    - service: notify.persistent_notification
      data:
        title: "üåßÔ∏è Huawei Solar"
        message: "Prognozowane zachmurzenie. Zwiƒôkszono ≈Çadowanie nocne."
