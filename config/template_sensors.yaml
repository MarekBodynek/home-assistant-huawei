# Template sensors dla algorytmu zarzÄ…dzania bateriÄ…
# Plik generowany automatycznie przez Claude Code

# ============================================
# STREFY TARYFOWE G12w
# ============================================

- sensor:
    - name: "Strefa taryfowa"
      unique_id: tariff_zone_g12w
      state: >
        {% set h = now().hour %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if not is_workday %}
          L2
        {% elif (h >= 22) or (h < 6) %}
          L2
        {% elif (h >= 13) and (h < 15) %}
          L2
        {% else %}
          L1
        {% endif %}
      icon: mdi:clock-time-four-outline
      attributes:
        friendly_name: "Strefa taryfowa G12w"
        description: "L1 (droga) lub L2 (tania) - weekendy i Å›wiÄ™ta CAÅY DZIEÅƒ L2!"

# ============================================
# DZIEÅƒ ROBOCZY (wykrywanie weekendÃ³w i Å›wiÄ…t)
# ============================================

- binary_sensor:
    - name: "DzieÅ„ roboczy"
      unique_id: workday_sensor
      state: >
        {% set dominated_days = [0, 1, 2, 3, 4] %}
        {% set today = now().weekday() %}
        {% set month = now().month %}
        {% set day = now().day %}

        {# Lista polskich Å›wiÄ…t staÅ‚ych (MM-DD) #}
        {% set holidays = [
          '01-01',
          '01-06',
          '05-01',
          '05-03',
          '08-15',
          '11-01',
          '11-11',
          '12-25',
          '12-26'
        ] %}

        {# ÅšwiÄ™ta ruchome 2024-2026 (Wielkanoc, PoniedziaÅ‚ek Wielkanocny, BoÅ¼e CiaÅ‚o) #}
        {% set movable_holidays = [
          '2024-03-31', '2024-04-01', '2024-05-30',
          '2025-04-20', '2025-04-21', '2025-06-19',
          '2026-04-05', '2026-04-06', '2026-06-04'
        ] %}

        {% set today_str = now().strftime('%m-%d') %}
        {% set today_full = now().strftime('%Y-%m-%d') %}

        {% set is_weekend = today not in dominated_days %}
        {% set is_holiday = today_str in holidays or today_full in movable_holidays %}

        {{ not is_weekend and not is_holiday }}
      icon: >
        {% if is_state('binary_sensor.dzien_roboczy', 'on') %}
          mdi:briefcase
        {% else %}
          mdi:home
        {% endif %}
      attributes:
        friendly_name: "DzieÅ„ roboczy"
        description: "ON = Pn-Pt (bez Å›wiÄ…t), OFF = weekend lub Å›wiÄ™to"
        today_weekday: "{{ ['PoniedziaÅ‚ek', 'Wtorek', 'Åšroda', 'Czwartek', 'PiÄ…tek', 'Sobota', 'Niedziela'][now().weekday()] }}"
        is_weekend: "{{ now().weekday() >= 5 }}"
        note: "UwzglÄ™dnia polskie Å›wiÄ™ta staÅ‚e + ruchome (2024-2026)"

# ============================================
# STREFA CZASOWA (CET/CEST)
# ============================================

- sensor:
    - name: "Timezone Offset"
      unique_id: timezone_offset_hours
      state: >
        {{ (now().utcoffset().total_seconds() / 3600) | int }}
      unit_of_measurement: "h"
      icon: mdi:clock-time-eight-outline
      attributes:
        friendly_name: "Offset strefy czasowej UTC"
        timezone_name: >
          {% set offset = (now().utcoffset().total_seconds() / 3600) | int %}
          {% if offset == 1 %}CET (zima){% elif offset == 2 %}CEST (lato){% else %}UTC+{{ offset }}{% endif %}
        description: "CET = UTC+1 (zima), CEST = UTC+2 (lato)"

# ============================================
# SEZON GRZEWCZY I TEMPERATURA
# ============================================

- binary_sensor:
    - name: "Sezon grzewczy"
      unique_id: heating_season
      state: >
        {{ states('sensor.temperatura_zewnetrzna') | float(20) < 12 }}
      icon: >
        {% if is_state('binary_sensor.sezon_grzewczy', 'on') %}
          mdi:radiator
        {% else %}
          mdi:radiator-off
        {% endif %}
      attributes:
        friendly_name: "Sezon grzewczy aktywny"
        threshold: "12Â°C"

- binary_sensor:
    - name: "PC CO aktywne"
      unique_id: pc_co_active
      state: >
        {{ states('climate.bodynek_nb_zone_1') == 'heat' }}
      icon: mdi:heat-pump
      attributes:
        friendly_name: "Pompa ciepÅ‚a - ogrzewanie aktywna"
        source: "Aquarea Smart Cloud (climate.bodynek_nb_zone_1)"

# ============================================
# OKNA CWU (CiepÅ‚a Woda UÅ¼ytkowa)
# ============================================

- binary_sensor:
    - name: "Okno CWU"
      unique_id: cwu_window
      state: >
        {% set h = now().hour %}
        {% set m = now().minute %}
        {% set time_decimal = h + (m / 60.0) %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if is_workday %}
          {{ (time_decimal >= 4.5 and time_decimal < 6) or (time_decimal >= 13 and time_decimal < 15) or (time_decimal >= 20 and time_decimal < 24) }}
        {% else %}
          {{ time_decimal >= 7 and time_decimal < 24 }}
        {% endif %}
      icon: >
        {% if is_state('binary_sensor.okno_cwu', 'on') %}
          mdi:water-boiler
        {% else %}
          mdi:water-boiler-off
        {% endif %}
      attributes:
        friendly_name: "Okno CWU aktywne"
        workday_windows: "04:30-06:00, 13:00-15:00, 20:00-23:59"
        weekend_window: "07:00-23:59"

- binary_sensor:
    - name: "CWU aktywne"
      unique_id: cwu_heating_active
      state: >
        {% set heating = states('water_heater.bodynek_nb_tank') == 'heating' %}
        {% set forced = is_state('switch.bodynek_nb_wymus_c_w_u', 'on') %}
        {{ heating or forced }}
      icon: >
        {% set heating = states('water_heater.bodynek_nb_tank') == 'heating' %}
        {% set forced = is_state('switch.bodynek_nb_wymus_c_w_u', 'on') %}
        {% if heating or forced %}
          mdi:water-boiler
        {% else %}
          mdi:water-boiler-off
        {% endif %}
      attributes:
        friendly_name: "CWU aktywne (grzeje lub wymuszone)"
        source: "Aquarea Smart Cloud (water_heater.bodynek_nb_tank)"
        temperatura_wody: "{{ state_attr('water_heater.bodynek_nb_tank', 'current_temperature') }}Â°C"
        temperatura_cel: "{{ state_attr('water_heater.bodynek_nb_tank', 'temperature') }}Â°C"
        wymuszone: "{{ is_state('switch.bodynek_nb_wymus_c_w_u', 'on') }}"

# ============================================
# CENY ENERGII - ZAKUP (z sieci) - RCE PSE
# ============================================

- sensor:
    - name: "Cena zakupu energii"
      unique_id: energy_buy_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
      icon: mdi:cash-multiple
      attributes:
        friendly_name: "Cena zakupu energii (RCE PSE)"
        zone: "{{ states('sensor.strefa_taryfowa') }}"
        source: "RCE PSE (PSE API)"
        rce_mwh: "{{ states('sensor.rce_pse_cena') }}"

# ============================================
# CENY ENERGII - SPRZEDAÅ» (do sieci) - RCE PSE
# ============================================

- sensor:
    - name: "Cena sprzedaÅ¼y energii"
      unique_id: energy_sell_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ ((states('sensor.rce_pse_cena') | float(550)) / 1000) | round(2) }}
      icon: mdi:cash-plus
      attributes:
        friendly_name: "Cena sprzedaÅ¼y energii (RCE PSE)"
        source: "RCE PSE (PSE API)"
        note: "Cena RCE = cena hurtowa"

# ============================================
# ÅšREDNIA CENA RCE WIECZORNA (zachÃ³d sÅ‚oÅ„ca â†’ 22:00)
# ============================================

- sensor:
    - name: "RCE Å›rednia wieczorna"
      unique_id: rce_evening_average
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set prices = state_attr('sensor.rce_pse_cena', 'prices') %}
        {% set sunset_hour = as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom('%H') | int %}
        {% set start_hour = sunset_hour + 1 %}
        {% if prices %}
          {% set ns = namespace(evening_prices=[]) %}
          {% for p in prices %}
            {% set hour = p.dtime.split(' ')[1].split(':')[0] | int %}
            {% if hour >= start_hour and hour < 22 %}
              {% set ns.evening_prices = ns.evening_prices + [p.rce_pln / 1000] %}
            {% endif %}
          {% endfor %}
          {% if ns.evening_prices | length > 0 %}
            {{ (ns.evening_prices | sum / ns.evening_prices | length) | round(2) }}
          {% else %}
            {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
          {% endif %}
        {% else %}
          {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
        {% endif %}
      icon: mdi:chart-line
      attributes:
        friendly_name: "RCE Å›rednia wieczorna (zachÃ³dâ†’22h)"
        sunset_hour: "{{ as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom('%H:%M') }}"
        start_hour: "{{ (as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom('%H') | int + 1) }}:00"
        end_hour: "22:00"
        source: "RCE PSE (zachÃ³d sÅ‚oÅ„ca â†’ 22:00)"

# ============================================
# RCE - PROGI CENOWE DLA KOLORÃ“W (DYNAMICZNE)
# ============================================
# Progi obliczane z rozkÅ‚adu cen w danym dniu:
# Zielony: dolne 33% (najtaÅ„sze godziny)
# Å»Ã³Å‚ty: Å›rodkowe 33-66%
# Czerwony: gÃ³rne 66-100% (najdroÅ¼sze godziny)

- sensor:
    - name: "RCE progi cenowe"
      unique_id: rce_price_thresholds
      state: >
        {% set today = now().strftime('%Y-%m-%d') %}
        {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
        {% set ns = namespace(today_prices=[]) %}
        {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
          {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
        {% endfor %}
        {% if ns.today_prices | length > 0 %}
          {% set sorted_prices = ns.today_prices | sort %}
          {% set p33_idx = ((sorted_prices | length) * 0.33) | int %}
          {% set p66_idx = ((sorted_prices | length) * 0.66) | int %}
          {{ sorted_prices[p33_idx] | round(2) }}-{{ sorted_prices[p66_idx] | round(2) }}
        {% else %}
          0.40-0.60
        {% endif %}
      icon: mdi:palette
      attributes:
        friendly_name: "Progi cenowe RCE (dynamiczne)"
        # Oblicz percentyle z dzisiejszych cen (6:00-21:00) - uÅ¼ywa namespace dla poprawnego dziaÅ‚ania
        p33: >
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
          {% set ns = namespace(today_prices=[]) %}
          {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
            {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {% if ns.today_prices | length > 0 %}
            {% set sorted_prices = ns.today_prices | sort %}
            {% set idx = ((sorted_prices | length) * 0.33) | int %}
            {{ sorted_prices[idx] | round(2) }}
          {% else %}0.40{% endif %}
        p66: >
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
          {% set ns = namespace(today_prices=[]) %}
          {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
            {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {% if ns.today_prices | length > 0 %}
            {% set sorted_prices = ns.today_prices | sort %}
            {% set idx = ((sorted_prices | length) * 0.66) | int %}
            {{ sorted_prices[idx] | round(2) }}
          {% else %}0.60{% endif %}
        min_price: >
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
          {% set ns = namespace(today_prices=[]) %}
          {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
            {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {{ (ns.today_prices | min | round(2)) if ns.today_prices else 0.30 }}
        max_price: >
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
          {% set ns = namespace(today_prices=[]) %}
          {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
            {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {{ (ns.today_prices | max | round(2)) if ns.today_prices else 0.80 }}
        legend: >
          {% set today = now().strftime('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}
          {% set ns = namespace(today_prices=[]) %}
          {% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}
            {% set ns.today_prices = ns.today_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {% if ns.today_prices | length > 0 %}
            {% set sorted_prices = ns.today_prices | sort %}
            {% set p33 = sorted_prices[((sorted_prices | length) * 0.33) | int] | round(2) %}
            {% set p66 = sorted_prices[((sorted_prices | length) * 0.66) | int] | round(2) %}
            ðŸŸ¢ < {{ p33 }}  ðŸŸ¡ {{ p33 }}â€“{{ p66 }}  ðŸ”´ > {{ p66 }} PLN/kWh
          {% else %}
            ðŸŸ¢ < 0,40  ðŸŸ¡ 0,40-0,60  ðŸ”´ > 0,60 PLN/kWh
          {% endif %}

    # Progi cenowe na JUTRO (obliczane z jutrzejszych cen)
    - name: "RCE progi cenowe jutro"
      unique_id: rce_price_thresholds_tomorrow
      state: >
        {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}
        {% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}
        {% set ns = namespace(tmr_prices=[]) %}
        {% for p in prices if p.dtime.startswith(tmr) %}
          {% set ns.tmr_prices = ns.tmr_prices + [p.rce_pln / 1000] %}
        {% endfor %}
        {% if ns.tmr_prices | length > 0 %}
          {% set sorted_prices = ns.tmr_prices | sort %}
          {% set p33_idx = ((sorted_prices | length) * 0.33) | int %}
          {% set p66_idx = ((sorted_prices | length) * 0.66) | int %}
          {{ sorted_prices[p33_idx] | round(2) }}-{{ sorted_prices[p66_idx] | round(2) }}
        {% else %}
          0.40-0.60
        {% endif %}
      icon: mdi:palette
      attributes:
        friendly_name: "Progi cenowe RCE jutro (dynamiczne)"
        p33: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}
          {% set ns = namespace(tmr_prices=[]) %}
          {% for p in prices if p.dtime.startswith(tmr) %}
            {% set ns.tmr_prices = ns.tmr_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {% if ns.tmr_prices | length > 0 %}
            {% set sorted_prices = ns.tmr_prices | sort %}
            {% set idx = ((sorted_prices | length) * 0.33) | int %}
            {{ sorted_prices[idx] | round(2) }}
          {% else %}0.40{% endif %}
        p66: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}
          {% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}
          {% set ns = namespace(tmr_prices=[]) %}
          {% for p in prices if p.dtime.startswith(tmr) %}
            {% set ns.tmr_prices = ns.tmr_prices + [p.rce_pln / 1000] %}
          {% endfor %}
          {% if ns.tmr_prices | length > 0 %}
            {% set sorted_prices = ns.tmr_prices | sort %}
            {% set idx = ((sorted_prices | length) * 0.66) | int %}
            {{ sorted_prices[idx] | round(2) }}
          {% else %}0.60{% endif %}

# ============================================
# RCE - CENY GODZINOWE (DZIÅš i JUTRO)
# ============================================
# WyÅ›wietla ÅšREDNIE ceny RCE dla kaÅ¼dej godziny z kolorowym znacznikiem
# WAÅ»NE: Åšrednia z 4 wartoÅ›ci kwartalnych (XX:00, XX:15, XX:30, XX:45)
#        aby byÄ‡ spÃ³jnym z algorytmem battery_algorithm.py
# Kolory oparte na percentylach: ðŸŸ¢ <p33, ðŸŸ¡ <p66, ðŸ”´ >=p66
# h00-h23 = dziÅ›, t00-t23 = jutro (peÅ‚na doba)

- sensor:
    - name: "RCE ceny godzinowe"
      unique_id: rce_hourly_prices
      state: >
        {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }} PLN/kWh
      icon: mdi:clock-time-four-outline
      attributes:
        friendly_name: "Ceny RCE godzinowe (dziÅ›/jutro)"
        today: "{{ now().strftime('%Y-%m-%d') }}"
        tomorrow: "{{ (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') }}"
        # DZIÅš - ceny na godzinÄ™ (h00-h23) - ÅšREDNIA z 4 wartoÅ›ci kwartalnych
        # Å¹rÃ³dÅ‚o: sensor.rce_pse_cena (dziÅ›)
        # ZAOKRÄ„GLENIE do 2 miejsc PRZED porÃ³wnaniem z progami (spÃ³jnoÅ›Ä‡ kolory vs wartoÅ›ci)
        h00: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '00' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h01: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '01' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h02: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '02' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h03: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '03' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h04: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '04' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h05: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '05' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h06: "{% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '06' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}"
        h07: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '07' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h08: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '08' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h09: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '09' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h10: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '10' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h11: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '11' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h12: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '12' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h13: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '13' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h14: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '14' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h15: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '15' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h16: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '16' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h17: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '17' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h18: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '18' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h19: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '19' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h20: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '20' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h21: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '21' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h22: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '22' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        h23: >
          {% set today = now().strftime('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena', 'prices') or [] %}{% set p33 = state_attr('sensor.rce_progi_cenowe', 'p33') | float(0.4) %}{% set p66 = state_attr('sensor.rce_progi_cenowe', 'p66') | float(0.6) %}{% set ns = namespace(hour_prices=[]) %}{% for p in prices if p.dtime.startswith(today) and p.dtime.split(' ')[1][:2] == '23' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% endif %}
        # JUTRO - ceny na godzinÄ™ (t00-t23) - ÅšREDNIA z 4 wartoÅ›ci kwartalnych
        # Å¹rÃ³dÅ‚o: sensor.rce_pse_cena_jutro (osobny sensor z danymi na jutro!)
        # PROGI p33/p66 obliczane Z JUTRZEJSZYCH CEN (nie dzisiejszych!)
        # ZAOKRÄ„GLENIE do 2 miejsc PRZED porÃ³wnaniem z progami (spÃ³jnoÅ›Ä‡ kolory vs wartoÅ›ci)
        t00: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '00' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t01: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '01' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t02: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '02' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t03: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '03' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t04: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '04' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t05: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '05' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t06: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '06' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t07: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '07' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t08: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '08' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t09: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '09' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t10: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '10' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t11: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '11' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t12: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '12' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t13: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '13' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t14: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '14' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t15: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '15' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t16: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '16' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t17: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '17' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t18: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '18' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t19: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '19' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t20: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '20' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t21: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] | int >= 6 and p.dtime.split(' ')[1][:2] | int <= 21 %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '21' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t22: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '22' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}
        t23: >
          {% set tmr = (as_timestamp(now()) + 86400) | timestamp_custom('%Y-%m-%d') %}{% set prices = state_attr('sensor.rce_pse_cena_jutro', 'prices') or [] %}{% set ns = namespace(all_prices=[], hour_prices=[]) %}{% for p in prices if p.dtime.startswith(tmr) %}{% set ns.all_prices = ns.all_prices + [p.rce_pln/1000] %}{% endfor %}{% set sorted_p = ns.all_prices | sort %}{% set p33 = sorted_p[((sorted_p | length) * 0.33) | int] | round(2) if sorted_p | length > 0 else 0.4 %}{% set p66 = sorted_p[((sorted_p | length) * 0.66) | int] | round(2) if sorted_p | length > 0 else 0.6 %}{% for p in prices if p.dtime.startswith(tmr) and p.dtime.split(' ')[1][:2] == '23' %}{% set ns.hour_prices = ns.hour_prices + [p.rce_pln/1000] %}{% endfor %}{% if ns.hour_prices | length > 0 %}{% set pr = ((ns.hour_prices | sum) / (ns.hour_prices | length)) | round(2) %}{% if pr < 0.2 %}ðŸ’š{% elif pr < p33 %}ðŸŸ¢{% elif pr < p66 %}ðŸŸ¡{% else %}ðŸ”´{% endif %}{{ '%.2f'|format(pr) }}{% else %}-{% endif %}

# ============================================
# PROGNOZA PV - POMOCNICZE SENSORY
# ============================================

# WspÃ³Å‚czynnik korekcji sezonowej - AUTO-KALIBRACJA EMA
# Czyta z input_text.pv_monthly_corrections (aktualizowane co wieczÃ³r)
# Fallback do domyÅ›lnych wartoÅ›ci gdy brak danych
- sensor:
    - name: "PV WspÃ³Å‚czynnik korekcji"
      unique_id: pv_correction_factor
      state: >
        {% set month = now().month | string %}
        {% set defaults = {"1":0.50,"2":0.60,"3":0.75,"4":0.85,"5":0.90,"6":0.90,"7":0.90,"8":0.90,"9":0.85,"10":0.75,"11":0.60,"12":0.50} %}
        {% set raw = states('input_text.pv_monthly_corrections') %}
        {% if raw and raw not in ['unknown', 'unavailable'] %}
          {% set corrections = raw | from_json %}
          {{ corrections.get(month, defaults.get(month, 0.75)) | float | round(2) }}
        {% else %}
          {{ defaults.get(month, 0.75) | float }}
        {% endif %}
      icon: mdi:percent
      attributes:
        friendly_name: "WspÃ³Å‚czynnik korekcji prognozy PV"
        description: "Auto-kalibracja EMA na podstawie real vs forecast"
        source: "{{ states('input_text.pv_monthly_corrections') }}"

- sensor:
    - name: "Prognoza PV dzisiaj"
      unique_id: forecast_pv_today
      unit_of_measurement: "kWh"
      state: >
        {% set wschod = states('sensor.pv_wschod_prognoza_dzis') | float(0) %}
        {% set poludnie = states('sensor.pv_poludnie_prognoza_dzis') | float(0) %}
        {% set zachod = states('sensor.pv_zachod_prognoza_dzis') | float(0) %}
        {% set factor = states('sensor.pv_wspolczynnik_korekcji') | float(0.75) %}
        {{ ((wschod + poludnie + zachod) * factor) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV dziÅ›"
        wschod: "{{ states('sensor.pv_wschod_prognoza_dzis') }}"
        poludnie: "{{ states('sensor.pv_poludnie_prognoza_dzis') }}"
        zachod: "{{ states('sensor.pv_zachod_prognoza_dzis') }}"
        raw_forecast: "{{ (states('sensor.pv_wschod_prognoza_dzis') | float(0) + states('sensor.pv_poludnie_prognoza_dzis') | float(0) + states('sensor.pv_zachod_prognoza_dzis') | float(0)) | round(1) }}"
        correction_factor: "{{ states('sensor.pv_wspolczynnik_korekcji') }}"

- sensor:
    - name: "Prognoza PV jutro"
      unique_id: forecast_pv_tomorrow
      unit_of_measurement: "kWh"
      state: >
        {% set wschod = states('sensor.pv_wschod_prognoza_jutro') | float(0) %}
        {% set poludnie = states('sensor.pv_poludnie_prognoza_jutro') | float(0) %}
        {% set zachod = states('sensor.pv_zachod_prognoza_jutro') | float(0) %}
        {% set factor = states('sensor.pv_wspolczynnik_korekcji') | float(0.75) %}
        {{ ((wschod + poludnie + zachod) * factor) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV jutro"
        wschod: "{{ states('sensor.pv_wschod_prognoza_jutro') }}"
        poludnie: "{{ states('sensor.pv_poludnie_prognoza_jutro') }}"
        zachod: "{{ states('sensor.pv_zachod_prognoza_jutro') }}"
        raw_forecast: "{{ (states('sensor.pv_wschod_prognoza_jutro') | float(0) + states('sensor.pv_poludnie_prognoza_jutro') | float(0) + states('sensor.pv_zachod_prognoza_jutro') | float(0)) | round(1) }}"
        correction_factor: "{{ states('sensor.pv_wspolczynnik_korekcji') }}"

- sensor:
    - name: "Prognoza PV 6h"
      unique_id: forecast_pv_6h
      unit_of_measurement: "kWh"
      state: >
        {% set hour = now().hour %}
        {% set wschod_wh = state_attr('sensor.pv_wschod_prognoza_dzis', 'watt_hours') or {} %}
        {% set poludnie_wh = state_attr('sensor.pv_poludnie_prognoza_dzis', 'watt_hours') or {} %}
        {% set zachod_wh = state_attr('sensor.pv_zachod_prognoza_dzis', 'watt_hours') or {} %}
        {% set factor = states('sensor.pv_wspolczynnik_korekcji') | float(0.75) %}
        {% set suma = 0 %}
        {% for i in range(1, 7) %}
          {% set h = hour + i %}
          {% set time_key = now().strftime('%Y-%m-%d') ~ ' ' ~ '%02d:00:00' | format(h) %}
          {% set w = wschod_wh.get(time_key, 0) | float / 1000 %}
          {% set p = poludnie_wh.get(time_key, 0) | float / 1000 %}
          {% set z = zachod_wh.get(time_key, 0) | float / 1000 %}
          {% set suma = suma + w + p + z %}
        {% endfor %}
        {{ (suma * factor) | round(1) }}
      icon: mdi:solar-power-variant
      attributes:
        friendly_name: "Prognoza PV nastÄ™pne 6h"

# ============================================
# CEL ÅADOWANIA BATERII (Target SOC)
# ============================================

- sensor:
    - name: "Cel SOC baterii"
      unique_id: battery_target_soc
      unit_of_measurement: "%"
      state: >
        {{ states('input_number.battery_target_soc') | int(70) }}
      icon: mdi:battery-charging-80
      attributes:
        friendly_name: "Docelowy poziom naÅ‚adowania baterii"
        description: "Obliczany o 04:00 przez calculate_daily_strategy()"

# ============================================
# TEMPERATURA ZEWNÄ˜TRZNA (z integracji pogody)
# ============================================

- sensor:
    - name: "Temperatura zewnÄ™trzna"
      unique_id: outdoor_temperature
      unit_of_measurement: "Â°C"
      state: >
        {{ state_attr('weather.forecast_dom', 'temperature') | float(10) }}
      icon: mdi:thermometer
      attributes:
        friendly_name: "Temperatura na zewnÄ…trz"

# ============================================
# BEZPIECZEÅƒSTWO TERMICZNE BATERII
# ============================================

- sensor:
    # TEMPERATURA BATERII - max z trzech Pack max temperatures
    - name: "Bateria - temperatura maksymalna"
      unique_id: battery_temperature_max
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.akumulator_1_pack_1_max_temperature') | float(0),
          states('sensor.akumulator_1_pack_2_max_temperature') | float(0),
          states('sensor.akumulator_1_pack_3_max_temperature') | float(0)
        ] %}
        {% set valid = temps | reject('eq', 0) | list %}
        {{ valid | max if valid | length > 0 else 25 }}
      icon: mdi:battery-thermometer
      attributes:
        friendly_name: "Bateria - temperatura max"
        source: "max(Pack 1/2/3 max temperature)"
        pack_1: "{{ states('sensor.akumulator_1_pack_1_max_temperature') }}"
        pack_2: "{{ states('sensor.akumulator_1_pack_2_max_temperature') }}"
        pack_3: "{{ states('sensor.akumulator_1_pack_3_max_temperature') }}"

    # TEMPERATURA BATERII - min z trzech Pack min temperatures
    - name: "Bateria - temperatura minimalna"
      unique_id: battery_temperature_min
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.akumulator_1_pack_1_min_temperature') | float(100),
          states('sensor.akumulator_1_pack_2_min_temperature') | float(100),
          states('sensor.akumulator_1_pack_3_min_temperature') | float(100)
        ] %}
        {% set valid = temps | reject('eq', 100) | list %}
        {{ valid | min if valid | length > 0 else 25 }}
      icon: mdi:battery-thermometer-outline
      attributes:
        friendly_name: "Bateria - temperatura min"
        source: "min(Pack 1/2/3 min temperature)"
        pack_1: "{{ states('sensor.akumulator_1_pack_1_min_temperature') }}"
        pack_2: "{{ states('sensor.akumulator_1_pack_2_min_temperature') }}"
        pack_3: "{{ states('sensor.akumulator_1_pack_3_min_temperature') }}"

    # TEMPERATURA OPTYMALIZATORÃ“W PV - dla referencji (JV* na dachu)
    - name: "PV Optimizers - temperatura maksymalna"
      unique_id: pv_optimizers_temperature_max
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.jv2279a93038_temperatura') | float(0),
          states('sensor.jv2279a93040_temperatura') | float(0),
          states('sensor.jv2279a93041_temperatura') | float(0),
          states('sensor.jv2279a93043_temperatura') | float(0),
          states('sensor.jv2279a93045_temperatura') | float(0),
          states('sensor.jv2279a93046_temperatura') | float(0),
          states('sensor.jv2279a93047_temperatura') | float(0),
          states('sensor.jv2279a93048_temperatura') | float(0),
          states('sensor.jv2279a93049_temperatura') | float(0),
          states('sensor.jv2279a93050_temperatura') | float(0),
          states('sensor.jv2279a93051_temperatura') | float(0),
          states('sensor.jv2279a93053_temperatura') | float(0),
          states('sensor.jv2279a93055_temperatura') | float(0),
          states('sensor.jv2279a93068_temperatura') | float(0),
          states('sensor.jv2279a93073_temperatura') | float(0),
          states('sensor.jv2279a93074_temperatura') | float(0),
          states('sensor.jv2279a93075_temperatura') | float(0)
        ] %}
        {% set valid_temps = temps | reject('eq', 0) | list %}
        {{ valid_temps | max if valid_temps | length > 0 else 0 }}
      icon: mdi:thermometer-high
      attributes:
        friendly_name: "PV Optymalizatory - najwyÅ¼sza temperatura"
        note: "Temperatura optymalizatorÃ³w PV (JV*) na dachu - dla referencji"
        valid_sensors: >
          {% set temps = [
            'JV...38: ' + states('sensor.jv2279a93038_temperatura'),
            'JV...40: ' + states('sensor.jv2279a93040_temperatura'),
            'JV...41: ' + states('sensor.jv2279a93041_temperatura'),
            'JV...43: ' + states('sensor.jv2279a93043_temperatura'),
            'JV...45: ' + states('sensor.jv2279a93045_temperatura')
          ] %}
          {{ temps | select('search', '[0-9]') | list | join(', ') if temps | select('search', '[0-9]') | list | length > 0 else 'Brak aktywnych sensorÃ³w' }}

- binary_sensor:
    - name: "Bateria - bezpieczna temperatura"
      unique_id: battery_temperature_safe
      # âœ… FIXED: UÅ¼ywa prawdziwej temperatury baterii z Huawei Solar (sensor.akumulator_1_temperatura)
      # Poprzednio: JV* (optymalizatory PV na dachu 7.8Â°C) - BÅÄ„D!
      # Teraz: sensor.akumulator_1_temperatura (~31.6Â°C) - POPRAWNE!
      state: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {{ temp >= 5 and temp <= 40 }}
      icon: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {% if temp > 43 %}
          mdi:fire-alert
        {% elif temp > 40 %}
          mdi:thermometer-alert
        {% elif temp < -5 %}
          mdi:snowflake-alert
        {% elif temp < 0 %}
          mdi:thermometer-low
        {% else %}
          mdi:thermometer-check
        {% endif %}
      attributes:
        friendly_name: "Bateria - bezpieczna temperatura"
        current_temp: >
          {% set temp = states('sensor.bateria_temperatura_maksymalna') %}
          {% if temp in ['unknown', 'unavailable'] %}
            Brak danych - sprawdÅº sensory Pack temperature
          {% else %}
            {{ temp }}Â°C
          {% endif %}
        safe_range: "5-40Â°C"
        optimal_range: "15-25Â°C"
        source: "max(Pack 1/2/3 max temperature)"
        status: >
          {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
          {% if temp > 45 %}
            EKSTREMALNIE NIEBEZPIECZNE (>45Â°C)
          {% elif temp > 40 %}
            KRYTYCZNE (>40Â°C)
          {% elif temp > 35 %}
            OSTRZEÅ»ENIE (>35Â°C)
          {% elif temp < 0 %}
            ZAMARZANIE (<0Â°C)
          {% elif temp < 5 %}
            ZA ZIMNO (<5Â°C)
          {% elif temp >= 15 and temp <= 25 %}
            OPTYMALNA (15-25Â°C)
          {% else %}
            BEZPIECZNA (5-40Â°C)
          {% endif %}

# ============================================
# PRODUKCJA PV - PRAWDZIWA (DC input z paneli)
# ============================================
# WAÅ»NE: sensor.inwerter_dzienna_produkcja = AC OUTPUT inwertera
#        = PV + rozÅ‚adowanie baterii - BÅÄ˜DNE dla produkcji PV!
#
# POPRAWNE: sensor.inwerter_total_dc_input_energy = DC input z paneli PV
#           Utility meter: sensor.dzienna_produkcja_pv_dc mierzy przyrost dzienny
#
# Weryfikacja (26.11.2025):
#   DC input o pÃ³Å‚nocy: 38152.41 kWh
#   DC input teraz: 38154.97 kWh
#   RÃ³Å¼nica = 2.56 kWh (zgadza siÄ™ z wykresem FusionSolar ~0.3-0.4kW Ã— 5-6h)

- sensor:
    - name: "Produkcja PV dzienna (rzeczywista)"
      unique_id: real_pv_daily_production
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      state: >
        {{ states('sensor.dzienna_produkcja_pv_dc') | float(0) | round(2) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Rzeczywista produkcja PV (dzienna)"
        source: "sensor.dzienna_produkcja_pv_dc (utility_meter)"
        dc_input_sensor: "sensor.inwerter_total_dc_input_energy"
        note: "Bazuje na DC input z paneli PV, nie AC output inwertera"

# ============================================
# BILANS MOCY
# ============================================

- sensor:
    - name: "NadwyÅ¼ka PV"
      unique_id: pv_surplus
      unit_of_measurement: "W"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) %}
        {% set consumption = states('sensor.zuzycie_domu_moc') | float(0) %}
        {% set surplus = pv - consumption %}
        {{ [surplus, 0] | max | round(0) | int }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "NadwyÅ¼ka energii z PV"

- sensor:
    - name: "Deficyt mocy"
      unique_id: power_deficit
      unit_of_measurement: "kW"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) / 1000 %}
        {% set load = states('sensor.pomiar_mocy_moc_czynna') | float(0) / 1000 | abs %}
        {% set deficit = load - pv %}
        {{ [deficit, 0] | max | round(2) }}
      icon: mdi:flash-alert
      attributes:
        friendly_name: "Deficyt mocy"

# ============================================
# ZUÅ»YCIE DOMU (zgodnie z FusionSolar)
# ============================================
# FormuÅ‚a FusionSolar: Dom = PV - Grid - Battery
# Konwencja Huawei: grid < 0 = IMPORT, grid > 0 = eksport
#                   battery > 0 = ÅADOWANIE, battery < 0 = rozÅ‚adowanie

- sensor:
    - name: "ZuÅ¼ycie domu - moc"
      unique_id: house_consumption_power
      unit_of_measurement: "W"
      device_class: power
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) %}
        {% set grid = states('sensor.pomiar_mocy_moc_czynna') | float(0) %}
        {% set battery = states('sensor.akumulatory_moc_ladowania_rozladowania') | float(0) %}
        {# Konwencja Huawei (FusionSolar):
           grid < 0 = IMPORT z sieci, grid > 0 = eksport do sieci
           battery > 0 = ÅADOWANIE, battery < 0 = rozÅ‚adowanie
           FormuÅ‚a: Dom = PV - Grid - Battery
        #}
        {% set house = pv - grid - battery %}
        {{ [house, 0] | max | round(0) }}
      icon: mdi:home-lightning-bolt
      attributes:
        friendly_name: "ZuÅ¼ycie domu (chwilowe)"
        pv_dc: "{{ states('sensor.inwerter_moc_wejsciowa') }} W"
        grid_power: "{{ states('sensor.pomiar_mocy_moc_czynna') }} W (- import, + eksport)"
        battery_power: "{{ states('sensor.akumulatory_moc_ladowania_rozladowania') }} W (+ Å‚adowanie, - rozÅ‚adowanie)"
        formula: "Dom = PV - Grid - Battery"
        note: "FormuÅ‚a zgodna z FusionSolar"

# ============================================
# LIMITY MOCY BATERII
# ============================================

- sensor:
    - name: "Bateria - max moc Å‚adowania"
      unique_id: battery_max_charge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_ladowania') | int(5000) }}
      icon: mdi:battery-charging-high
      attributes:
        friendly_name: "Maksymalna moc Å‚adowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"

- sensor:
    - name: "Bateria - max moc rozÅ‚adowania"
      unique_id: battery_max_discharge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_rozladowania') | int(5000) }}
      icon: mdi:battery-minus
      attributes:
        friendly_name: "Maksymalna moc rozÅ‚adowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"
        note: "0W = blokada rozÅ‚adowania (tryb L2)"

# ============================================
# WYKRYWANIE AWARII SIECI (BACKUP MODE)
# ============================================

- binary_sensor:
    - name: "Awaria sieci"
      unique_id: grid_power_outage
      device_class: problem
      state: >
        {# Wykrywanie braku napiÄ™cia w sieci #}
        {# Metody detekcji: #}
        {# 1. Sensor pomiar_mocy jest unavailable #}
        {# 2. Inwerter w trybie off-grid/backup #}
        {# 3. NapiÄ™cie sieci < 180V (jeÅ›li sensor istnieje) #}

        {% set grid_sensor = states('sensor.pomiar_mocy_moc_czynna') %}
        {% set inverter_state = states('sensor.inwerter_stan') %}

        {# SprawdÅº czy sensor sieci jest niedostÄ™pny #}
        {% set grid_unavailable = grid_sensor in ['unavailable', 'unknown'] %}

        {# SprawdÅº stan inwertera (Huawei pokazuje rÃ³Å¼ne stany) #}
        {% set backup_states = ['off-grid', 'backup', 'standby', 'fault', 'shutdown'] %}
        {% set inverter_backup = inverter_state | lower in backup_states %}

        {# SprawdÅº napiÄ™cie sieci (jeÅ›li sensor istnieje) #}
        {% set grid_voltage = states('sensor.grid_voltage') | float(-1) %}
        {% set voltage_low = grid_voltage > 0 and grid_voltage < 180 %}

        {{ grid_unavailable or inverter_backup or voltage_low }}
      icon: >
        {% if is_state('binary_sensor.awaria_sieci', 'on') %}
          mdi:transmission-tower-off
        {% else %}
          mdi:transmission-tower
        {% endif %}
      attributes:
        friendly_name: "Awaria zasilania sieci"
        grid_sensor_state: "{{ states('sensor.pomiar_mocy_moc_czynna') }}"
        inverter_state: "{{ states('sensor.inwerter_stan') }}"
        detection_method: >
          {% set grid_sensor = states('sensor.pomiar_mocy_moc_czynna') %}
          {% if grid_sensor in ['unavailable', 'unknown'] %}
            Sensor sieci niedostÄ™pny
          {% elif states('sensor.inwerter_stan') | lower in ['off-grid', 'backup', 'fault'] %}
            Inwerter w trybie backup
          {% else %}
            SieÄ‡ OK
          {% endif %}

# ============================================
# SYSTEM BÅÄ˜DÃ“W I MONITORINGU
# ============================================

- sensor:
    # ===== LICZNIK BÅÄ˜DÃ“W ALGORYTMU =====
    - name: "BÅ‚Ä™dy Algorytmu - Licznik"
      unique_id: algorithm_errors_count
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {% if 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision %}
          {{ states('sensor.bledy_algorytmu_licznik') | int(0) + 1 }}
        {% else %}
          {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
        {% endif %}
      attributes:
        friendly_name: "BÅ‚Ä™dy algorytmu (dziÅ›)"
        last_error: "{{ states('input_text.battery_decision_reason') }}"
        icon: mdi:alert-circle

    # ===== OSTATNI BÅÄ„D SYSTEMU =====
    # POPRAWIONE: Pokazuje tylko PRAWDZIWE bÅ‚Ä™dy, nie normalne decyzje algorytmu
    - name: "System - Ostatni BÅ‚Ä…d"
      unique_id: system_last_error
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {% set is_algorithm_error = 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision or 'ðŸš¨' in decision %}
        {% set huawei_error = state_attr('binary_sensor.huawei_connection_status', 'last_error') %}
        {% set rce_unavailable = states('sensor.rce_pse_cena') in ['unavailable', 'unknown'] %}

        {% if is_algorithm_error %}
          {{ decision[:200] }}
        {% elif huawei_error %}
          Huawei Solar: {{ huawei_error }}
        {% elif rce_unavailable %}
          RCE PSE: niedostÄ™pny
        {% else %}
          Brak bÅ‚Ä™dÃ³w
        {% endif %}
      attributes:
        friendly_name: "Ostatni bÅ‚Ä…d systemu"
        last_decision: "{{ states('input_text.battery_decision_reason') }}"
        has_error: >
          {% set decision = states('input_text.battery_decision_reason') %}
          {{ 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision or 'ðŸš¨' in decision }}
        huawei_status: "{{ 'OK' if states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        rce_status: "{{ 'OK' if states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        icon: mdi:alert-octagon

- binary_sensor:
    # ===== STATUS SYSTEMÃ“W =====
    - name: "System - BÅ‚Ä…d Krytyczny"
      unique_id: system_critical_error
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {{ 'BÅÄ„D' in decision or 'ðŸš¨' in decision or 'ZATRZYMANO' in decision }}
      attributes:
        friendly_name: "BÅ‚Ä…d krytyczny w systemie"
        details: "{{ states('input_text.battery_decision_reason') }}"
        icon: mdi:alert-circle
      device_class: problem

    # ===== MONITORING INTEGRACJI =====
    - name: "Integracje - Status"
      unique_id: integrations_status
      state: >
        {% set huawei = states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] %}
        {% set rce = states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] %}
        {% set forecast = states('sensor.prognoza_pv_jutro') not in ['unavailable', 'unknown'] %}
        {{ huawei and rce and forecast }}
      attributes:
        friendly_name: "Status integracji"
        huawei_solar: "{{ 'OK' if states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        rce_pse: "{{ 'OK' if states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        forecast_solar: "{{ 'OK' if states('sensor.prognoza_pv_jutro') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        icon: mdi:lan-connect
      device_class: connectivity

# ============================================
# PORÃ“WNANIE TARYFOWE: G12w vs Pstryk Dynamiczna
# ============================================
# Symulacja kosztÃ³w â€” co zapÅ‚aciÅ‚byÅ› z taryfÄ… dynamicznÄ… Pstryk?
# Pstryk netto = RCE/kWh + 0.08 (marÅ¼a) + 0.07 (dystrybucja) + 0.005 (akcyza)
# G12w: L1 = 1.16 PLN/kWh, L2 = 0.78 PLN/kWh (brutto, z rachunku)

- sensor:
    - name: "Pstryk cena dynamiczna"
      unique_id: pstryk_dynamic_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set rce_kwh = states('sensor.rce_pse_cena') | float(400) / 1000 %}
        {{ ((rce_kwh + 0.155) * 1.23) | round(4) }}
      icon: mdi:lightning-bolt
      attributes:
        friendly_name: "Pstryk cena dynamiczna (brutto)"
        rce_pln_mwh: "{{ states('sensor.rce_pse_cena') | float(0) | round(0) }}"
        netto: "{{ (states('sensor.rce_pse_cena') | float(400) / 1000 + 0.155) | round(4) }}"
        marza: 0.08
        dystrybucja: 0.07
        akcyza: 0.005
        vat: "23%"

    - name: "G12w cena teraz"
      unique_id: g12w_current_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set zone = states('sensor.strefa_taryfowa') %}
        {% if zone == 'L1' %}1.16{% else %}0.78{% endif %}
      icon: mdi:cash
      attributes:
        friendly_name: "G12w cena aktualna (brutto)"
        strefa: "{{ states('sensor.strefa_taryfowa') }}"

    - name: "Pstryk oszczÄ™dnoÅ›Ä‡ za kWh"
      unique_id: pstryk_savings_per_kwh
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set g12w = states('sensor.g12w_cena_teraz') | float(0.78) %}
        {% set pstryk = states('sensor.pstryk_cena_dynamiczna') | float(0.50) %}
        {{ (g12w - pstryk) | round(4) }}
      icon: mdi:piggy-bank
      attributes:
        friendly_name: "OszczÄ™dnoÅ›Ä‡ Pstryk vs G12w (na kWh)"
        pstryk_tanszy: "{{ states('sensor.g12w_cena_teraz') | float(0) > states('sensor.pstryk_cena_dynamiczna') | float(0) }}"

    - name: "Pstryk oszczÄ™dnoÅ›Ä‡ dzienna"
      unique_id: pstryk_daily_savings
      unit_of_measurement: "PLN"
      state: >
        {% set g12w = states('input_number.g12w_koszt_import_dzienny') | float(0) %}
        {% set pstryk = states('input_number.pstryk_koszt_import_dzienny') | float(0) %}
        {{ (g12w - pstryk) | round(2) }}
      icon: mdi:piggy-bank-outline
      attributes:
        friendly_name: "OszczÄ™dnoÅ›Ä‡ Pstryk dzienna"
        g12w_koszt: "{{ states('input_number.g12w_koszt_import_dzienny') | float(0) | round(2) }}"
        pstryk_koszt: "{{ states('input_number.pstryk_koszt_import_dzienny') | float(0) | round(2) }}"

    - name: "Pstryk oszczÄ™dnoÅ›Ä‡ miesiÄ™czna"
      unique_id: pstryk_monthly_savings
      unit_of_measurement: "PLN"
      state: >
        {% set g12w = states('input_number.g12w_koszt_import_miesiac') | float(0) %}
        {% set pstryk = states('input_number.pstryk_koszt_import_miesiac') | float(0) %}
        {{ (g12w - pstryk) | round(2) }}
      icon: mdi:piggy-bank
      attributes:
        friendly_name: "OszczÄ™dnoÅ›Ä‡ Pstryk miesiÄ™czna"
        g12w_koszt: "{{ states('input_number.g12w_koszt_import_miesiac') | float(0) | round(2) }}"
        pstryk_koszt: "{{ states('input_number.pstryk_koszt_import_miesiac') | float(0) | round(2) }}"

# ============================================
# EVENT LOG - Historia zdarzeÅ„ systemowych
# ============================================

- sensor:
    # ===== PARSOWANY EVENT LOG - OSTATNIE ZDARZENIE =====
    - name: "Event Log - Ostatnie Zdarzenie"
      unique_id: event_log_latest
      state: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw != 'unknown' and raw != '' %}
          {% set event = raw | from_json %}
          {{ event.get('msg', 'Brak danych')[:50] }}
        {% else %}
          Brak zdarzeÅ„
        {% endif %}
      attributes:
        friendly_name: "Ostatnie zdarzenie"
        timestamp: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('ts', '') }}
          {% else %}
            -
          {% endif %}
        level: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('lvl', 'INFO') }}
          {% else %}
            INFO
          {% endif %}
        category: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('cat', '') }}
          {% else %}
            -
          {% endif %}
        full_message: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('msg', '') }}
          {% else %}
            -
          {% endif %}
        icon: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {% set lvl = event.get('lvl', 'INFO') %}
            {% if lvl == 'ERROR' %}mdi:alert-circle
            {% elif lvl == 'WARNING' %}mdi:alert
            {% elif lvl == 'DEBUG' %}mdi:bug
            {% else %}mdi:information
            {% endif %}
          {% else %}
            mdi:information
          {% endif %}

    # ===== HISTORIA ZDARZEÅƒ - 5 OSTATNICH =====
    - name: "Event Log - Historia"
      unique_id: event_log_history
      state: >
        {% set slots = [
          states('input_text.event_log_1'),
          states('input_text.event_log_2'),
          states('input_text.event_log_3'),
          states('input_text.event_log_4'),
          states('input_text.event_log_5')
        ] %}
        {% set valid = slots | select('ne', '') | select('ne', 'unknown') | list %}
        {% set count = 0 %}
        {% for s in valid %}
          {% set event = s | from_json %}
          {% if event.get('msg', '') != '' %}
            {% set count = count + 1 %}
          {% endif %}
        {% endfor %}
        {{ count }} zdarzeÅ„
      attributes:
        friendly_name: "Historia zdarzeÅ„ (5 ostatnich)"
        event_1: "{{ states('input_text.event_log_1') }}"
        event_2: "{{ states('input_text.event_log_2') }}"
        event_3: "{{ states('input_text.event_log_3') }}"
        event_4: "{{ states('input_text.event_log_4') }}"
        event_5: "{{ states('input_text.event_log_5') }}"
        # Statystyki per poziom (z ostatnich 5)
        errors_count: >
          {% set count = 0 %}
          {% for i in range(1, 6) %}
            {% set raw = states('input_text.event_log_' ~ i) %}
            {% if raw and raw not in ['', 'unknown'] %}
              {% set event = raw | from_json %}
              {% if event.get('lvl') == 'ERROR' %}
                {% set count = count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ count }}
        warnings_count: >
          {% set count = 0 %}
          {% for i in range(1, 6) %}
            {% set raw = states('input_text.event_log_' ~ i) %}
            {% if raw and raw not in ['', 'unknown'] %}
              {% set event = raw | from_json %}
              {% if event.get('lvl') == 'WARNING' %}
                {% set count = count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ count }}
        icon: mdi:history

    # ===== FORMATOWANA LISTA ZDARZEÅƒ (dla Markdown card) =====
    - name: "Event Log - Markdown"
      unique_id: event_log_markdown
      state: "event_log"
      attributes:
        friendly_name: "Event Log (Markdown)"
        slot_1: "{{ states('input_text.event_log_1') }}"
        slot_2: "{{ states('input_text.event_log_2') }}"
        slot_3: "{{ states('input_text.event_log_3') }}"
        slot_4: "{{ states('input_text.event_log_4') }}"
        slot_5: "{{ states('input_text.event_log_5') }}"
        icon: mdi:format-list-bulleted

    # ===== TEMPERATURA CO (dla gauge) =====
    - name: "Temperatura CO"
      unique_id: temperatura_co
      state: "{{ state_attr('climate.bodynek_nb_zone_1', 'current_temperature') | float(0) }}"
      unit_of_measurement: "Â°C"
      device_class: temperature
      icon: mdi:thermometer

    # ===== TEMPERATURA CWU (dla gauge) =====
    - name: "Temperatura CWU"
      unique_id: temperatura_cwu
      state: "{{ state_attr('water_heater.bodynek_nb_tank', 'current_temperature') | float(0) }}"
      unit_of_measurement: "Â°C"
      device_class: temperature
      icon: mdi:water-boiler

    # ===== SEZONOWE LIMITY SOC BATERII =====
    - name: "Bateria - limity SOC"
      unique_id: battery_soc_limits
      state: >
        {% set month = now().month %}
        {% if month in [11, 12, 1, 2] %}
          10-90%
        {% elif month in [3, 4] %}
          15-85%
        {% elif month in [5, 6, 7, 8, 9] %}
          20-80%
        {% else %}
          15-85%
        {% endif %}
      icon: mdi:battery-clock
      attributes:
        friendly_name: "Sezonowe limity SOC"
        season: >
          {% set month = now().month %}
          {% if month in [11, 12, 1, 2] %}
            Zima
          {% elif month in [3, 4] %}
            Wiosna
          {% elif month in [5, 6, 7, 8, 9] %}
            Lato
          {% else %}
            JesieÅ„
          {% endif %}
        min_soc: >
          {% set month = now().month %}
          {% if month in [11, 12, 1, 2] %}
            10
          {% elif month in [3, 4, 10] %}
            15
          {% else %}
            20
          {% endif %}
        max_soc: >
          {% set month = now().month %}
          {% if month in [11, 12, 1, 2] %}
            90
          {% elif month in [3, 4, 10] %}
            85
          {% else %}
            80
          {% endif %}
        description: "Zima (XI-II): 10-90%, Wiosna (III-IV): 15-85%, Lato (V-IX): 20-80%, JesieÅ„ (X): 15-85%"

# ============================================
# SEZONOWE LIMITY SOC - osobne sensory
# ============================================

- sensor:
    - name: "Battery SOC Min"
      unique_id: battery_soc_min
      state: >
        {% set month = now().month %}
        {% if month in [11, 12, 1, 2] %}10
        {% elif month in [3, 4, 10] %}15
        {% else %}20{% endif %}
      unit_of_measurement: "%"
      icon: mdi:battery-arrow-down

    - name: "Battery SOC Max"
      unique_id: battery_soc_max
      state: >
        {% set month = now().month %}
        {% if month in [11, 12, 1, 2] %}90
        {% elif month in [3, 4, 10] %}85
        {% else %}80{% endif %}
      unit_of_measurement: "%"
      icon: mdi:battery-arrow-up
