# Template sensors dla algorytmu zarzÄ…dzania bateriÄ…
# Plik generowany automatycznie przez Claude Code

# ============================================
# STREFY TARYFOWE G12w
# ============================================

- sensor:
    - name: "Strefa taryfowa"
      unique_id: tariff_zone_g12w
      state: >
        {% set h = now().hour %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if not is_workday %}
          L2
        {% elif (h >= 22) or (h < 6) %}
          L2
        {% elif (h >= 13) and (h < 15) %}
          L2
        {% else %}
          L1
        {% endif %}
      icon: mdi:clock-time-four-outline
      attributes:
        friendly_name: "Strefa taryfowa G12w"
        description: "L1 (droga) lub L2 (tania) - weekendy i Å›wiÄ™ta CAÅY DZIEÅƒ L2!"

# ============================================
# DZIEÅƒ ROBOCZY (wykrywanie weekendÃ³w i Å›wiÄ…t)
# ============================================

- binary_sensor:
    - name: "DzieÅ„ roboczy"
      unique_id: workday_sensor
      state: >
        {% set dominated_days = [0, 1, 2, 3, 4] %}
        {% set today = now().weekday() %}
        {% set month = now().month %}
        {% set day = now().day %}

        {# Lista polskich Å›wiÄ…t staÅ‚ych (MM-DD) #}
        {% set holidays = [
          '01-01',
          '01-06',
          '05-01',
          '05-03',
          '08-15',
          '11-01',
          '11-11',
          '12-25',
          '12-26'
        ] %}

        {# ÅšwiÄ™ta ruchome 2024-2026 (Wielkanoc, PoniedziaÅ‚ek Wielkanocny, BoÅ¼e CiaÅ‚o) #}
        {% set movable_holidays = [
          '2024-03-31', '2024-04-01', '2024-05-30',
          '2025-04-20', '2025-04-21', '2025-06-19',
          '2026-04-05', '2026-04-06', '2026-06-04'
        ] %}

        {% set today_str = now().strftime('%m-%d') %}
        {% set today_full = now().strftime('%Y-%m-%d') %}

        {% set is_weekend = today not in dominated_days %}
        {% set is_holiday = today_str in holidays or today_full in movable_holidays %}

        {{ not is_weekend and not is_holiday }}
      icon: >
        {% if is_state('binary_sensor.dzien_roboczy', 'on') %}
          mdi:briefcase
        {% else %}
          mdi:home
        {% endif %}
      attributes:
        friendly_name: "DzieÅ„ roboczy"
        description: "ON = Pn-Pt (bez Å›wiÄ…t), OFF = weekend lub Å›wiÄ™to"
        today_weekday: "{{ ['PoniedziaÅ‚ek', 'Wtorek', 'Åšroda', 'Czwartek', 'PiÄ…tek', 'Sobota', 'Niedziela'][now().weekday()] }}"
        is_weekend: "{{ now().weekday() >= 5 }}"
        note: "UwzglÄ™dnia polskie Å›wiÄ™ta staÅ‚e + ruchome (2024-2026)"

# ============================================
# SEZON GRZEWCZY I TEMPERATURA
# ============================================

- binary_sensor:
    - name: "Sezon grzewczy"
      unique_id: heating_season
      state: >
        {{ states('sensor.temperatura_zewnetrzna') | float(20) < 12 }}
      icon: >
        {% if is_state('binary_sensor.sezon_grzewczy', 'on') %}
          mdi:radiator
        {% else %}
          mdi:radiator-off
        {% endif %}
      attributes:
        friendly_name: "Sezon grzewczy aktywny"
        threshold: "12Â°C"

- binary_sensor:
    - name: "PC CO aktywne"
      unique_id: pc_co_active
      state: >
        {{ states('sensor.temperatura_zewnetrzna') | float(20) < 12 }}
      icon: mdi:heat-pump
      attributes:
        friendly_name: "Pompa ciepÅ‚a - ogrzewanie aktywna"

# ============================================
# OKNA CWU (CiepÅ‚a Woda UÅ¼ytkowa)
# ============================================

- binary_sensor:
    - name: "Okno CWU"
      unique_id: cwu_window
      state: >
        {% set h = now().hour %}
        {% set m = now().minute %}
        {% set time_decimal = h + (m / 60.0) %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if is_workday %}
          {{ (time_decimal >= 4.5 and time_decimal < 6) or (time_decimal >= 13 and time_decimal < 15) or (time_decimal >= 20 and time_decimal < 24) }}
        {% else %}
          {{ time_decimal >= 7 and time_decimal < 24 }}
        {% endif %}
      icon: >
        {% if is_state('binary_sensor.okno_cwu', 'on') %}
          mdi:water-boiler
        {% else %}
          mdi:water-boiler-off
        {% endif %}
      attributes:
        friendly_name: "Okno CWU aktywne"
        workday_windows: "04:30-06:00, 13:00-15:00, 20:00-23:59"
        weekend_window: "07:00-23:59"

# ============================================
# CENY ENERGII - ZAKUP (z sieci) - RCE PSE
# ============================================

- sensor:
    - name: "Cena zakupu energii"
      unique_id: energy_buy_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
      icon: mdi:cash-multiple
      attributes:
        friendly_name: "Cena zakupu energii (RCE PSE)"
        zone: "{{ states('sensor.strefa_taryfowa') }}"
        source: "RCE PSE (PSE API)"
        rce_mwh: "{{ states('sensor.rce_pse_cena') }}"

# ============================================
# CENY ENERGII - SPRZEDAÅ» (do sieci) - RCE PSE
# ============================================

- sensor:
    - name: "Cena sprzedaÅ¼y energii"
      unique_id: energy_sell_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ ((states('sensor.rce_pse_cena') | float(550)) / 1000) | round(2) }}
      icon: mdi:cash-plus
      attributes:
        friendly_name: "Cena sprzedaÅ¼y energii (RCE PSE)"
        source: "RCE PSE (PSE API)"
        note: "Cena RCE = cena hurtowa"

# ============================================
# ÅšREDNIA CENA RCE WIECZORNA (19-22h) - RCE PSE
# ============================================

- sensor:
    - name: "RCE Å›rednia wieczorna"
      unique_id: rce_evening_average
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set prices = state_attr('sensor.rce_pse_cena', 'prices') %}
        {% if prices %}
          {% set evening_prices = [] %}
          {% for p in prices %}
            {% set hour = p.dtime.split(' ')[1].split(':')[0] | int %}
            {% if hour in [19, 20, 21] %}
              {% set evening_prices = evening_prices + [p.rce_pln / 1000] %}
            {% endif %}
          {% endfor %}
          {% if evening_prices | length > 0 %}
            {{ (evening_prices | sum / evening_prices | length) | round(2) }}
          {% else %}
            {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
          {% endif %}
        {% else %}
          {{ ((states('sensor.rce_pse_cena') | float(650)) / 1000) | round(2) }}
        {% endif %}
      icon: mdi:chart-line
      attributes:
        friendly_name: "RCE Å›rednia wieczorna (19-22h)"
        source: "RCE PSE (PSE API)"

# ============================================
# PROGNOZA PV - POMOCNICZE SENSORY
# ============================================

- sensor:
    - name: "Prognoza PV dzisiaj"
      unique_id: forecast_pv_today
      unit_of_measurement: "kWh"
      state: >
        {% set wschod = states('sensor.pv_wschod_prognoza_dzis') | float(0) %}
        {% set poludnie = states('sensor.pv_poludnie_prognoza_dzis') | float(0) %}
        {% set zachod = states('sensor.pv_zachod_prognoza_dzis') | float(0) %}
        {{ (wschod + poludnie + zachod) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV dziÅ›"
        wschod: "{{ states('sensor.pv_wschod_prognoza_dzis') }}"
        poludnie: "{{ states('sensor.pv_poludnie_prognoza_dzis') }}"
        zachod: "{{ states('sensor.pv_zachod_prognoza_dzis') }}"

- sensor:
    - name: "Prognoza PV jutro"
      unique_id: forecast_pv_tomorrow
      unit_of_measurement: "kWh"
      state: >
        {% set wschod = states('sensor.pv_wschod_prognoza_jutro') | float(0) %}
        {% set poludnie = states('sensor.pv_poludnie_prognoza_jutro') | float(0) %}
        {% set zachod = states('sensor.pv_zachod_prognoza_jutro') | float(0) %}
        {{ (wschod + poludnie + zachod) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV jutro"
        wschod: "{{ states('sensor.pv_wschod_prognoza_jutro') }}"
        poludnie: "{{ states('sensor.pv_poludnie_prognoza_jutro') }}"
        zachod: "{{ states('sensor.pv_zachod_prognoza_jutro') }}"

- sensor:
    - name: "Prognoza PV 6h"
      unique_id: forecast_pv_6h
      unit_of_measurement: "kWh"
      state: >
        {% set hour = now().hour %}
        {% set wschod_wh = state_attr('sensor.pv_wschod_prognoza_dzis', 'watt_hours') or {} %}
        {% set poludnie_wh = state_attr('sensor.pv_poludnie_prognoza_dzis', 'watt_hours') or {} %}
        {% set zachod_wh = state_attr('sensor.pv_zachod_prognoza_dzis', 'watt_hours') or {} %}
        {% set suma = 0 %}
        {% for i in range(1, 7) %}
          {% set h = hour + i %}
          {% set time_key = now().strftime('%Y-%m-%d') ~ ' ' ~ '%02d:00:00' | format(h) %}
          {% set w = wschod_wh.get(time_key, 0) | float / 1000 %}
          {% set p = poludnie_wh.get(time_key, 0) | float / 1000 %}
          {% set z = zachod_wh.get(time_key, 0) | float / 1000 %}
          {% set suma = suma + w + p + z %}
        {% endfor %}
        {{ suma | round(1) }}
      icon: mdi:solar-power-variant
      attributes:
        friendly_name: "Prognoza PV nastÄ™pne 6h"

# ============================================
# CEL ÅADOWANIA BATERII (Target SOC)
# ============================================

- sensor:
    - name: "Cel SOC baterii"
      unique_id: battery_target_soc
      unit_of_measurement: "%"
      state: >
        {{ states('input_number.battery_target_soc') | int(70) }}
      icon: mdi:battery-charging-80
      attributes:
        friendly_name: "Docelowy poziom naÅ‚adowania baterii"
        description: "Obliczany o 04:00 przez calculate_daily_strategy()"

# ============================================
# TEMPERATURA ZEWNÄ˜TRZNA (z integracji pogody)
# ============================================

- sensor:
    - name: "Temperatura zewnÄ™trzna"
      unique_id: outdoor_temperature
      unit_of_measurement: "Â°C"
      state: >
        {{ state_attr('weather.forecast_dom', 'temperature') | float(10) }}
      icon: mdi:thermometer
      attributes:
        friendly_name: "Temperatura na zewnÄ…trz"

# ============================================
# BEZPIECZEÅƒSTWO TERMICZNE BATERII
# ============================================

- sensor:
    # TEMPERATURA BATERII - max z trzech Pack max temperatures
    - name: "Bateria - temperatura maksymalna"
      unique_id: battery_temperature_max
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.akumulator_1_pack_1_max_temperature') | float(0),
          states('sensor.akumulator_1_pack_2_max_temperature') | float(0),
          states('sensor.akumulator_1_pack_3_max_temperature') | float(0)
        ] %}
        {% set valid = temps | reject('eq', 0) | list %}
        {{ valid | max if valid | length > 0 else 25 }}
      icon: mdi:battery-thermometer
      attributes:
        friendly_name: "Bateria - temperatura max"
        source: "max(Pack 1/2/3 max temperature)"
        pack_1: "{{ states('sensor.akumulator_1_pack_1_max_temperature') }}"
        pack_2: "{{ states('sensor.akumulator_1_pack_2_max_temperature') }}"
        pack_3: "{{ states('sensor.akumulator_1_pack_3_max_temperature') }}"

    # TEMPERATURA BATERII - min z trzech Pack min temperatures
    - name: "Bateria - temperatura minimalna"
      unique_id: battery_temperature_min
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.akumulator_1_pack_1_min_temperature') | float(100),
          states('sensor.akumulator_1_pack_2_min_temperature') | float(100),
          states('sensor.akumulator_1_pack_3_min_temperature') | float(100)
        ] %}
        {% set valid = temps | reject('eq', 100) | list %}
        {{ valid | min if valid | length > 0 else 25 }}
      icon: mdi:battery-thermometer-outline
      attributes:
        friendly_name: "Bateria - temperatura min"
        source: "min(Pack 1/2/3 min temperature)"
        pack_1: "{{ states('sensor.akumulator_1_pack_1_min_temperature') }}"
        pack_2: "{{ states('sensor.akumulator_1_pack_2_min_temperature') }}"
        pack_3: "{{ states('sensor.akumulator_1_pack_3_min_temperature') }}"

    # TEMPERATURA OPTYMALIZATORÃ“W PV - dla referencji (JV* na dachu)
    - name: "PV Optimizers - temperatura maksymalna"
      unique_id: pv_optimizers_temperature_max
      unit_of_measurement: "Â°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.jv2279a93038_temperatura') | float(0),
          states('sensor.jv2279a93040_temperatura') | float(0),
          states('sensor.jv2279a93041_temperatura') | float(0),
          states('sensor.jv2279a93043_temperatura') | float(0),
          states('sensor.jv2279a93045_temperatura') | float(0),
          states('sensor.jv2279a93046_temperatura') | float(0),
          states('sensor.jv2279a93047_temperatura') | float(0),
          states('sensor.jv2279a93048_temperatura') | float(0),
          states('sensor.jv2279a93049_temperatura') | float(0),
          states('sensor.jv2279a93050_temperatura') | float(0),
          states('sensor.jv2279a93051_temperatura') | float(0),
          states('sensor.jv2279a93053_temperatura') | float(0),
          states('sensor.jv2279a93055_temperatura') | float(0),
          states('sensor.jv2279a93068_temperatura') | float(0),
          states('sensor.jv2279a93073_temperatura') | float(0),
          states('sensor.jv2279a93074_temperatura') | float(0),
          states('sensor.jv2279a93075_temperatura') | float(0)
        ] %}
        {% set valid_temps = temps | reject('eq', 0) | list %}
        {{ valid_temps | max if valid_temps | length > 0 else 0 }}
      icon: mdi:thermometer-high
      attributes:
        friendly_name: "PV Optymalizatory - najwyÅ¼sza temperatura"
        note: "Temperatura optymalizatorÃ³w PV (JV*) na dachu - dla referencji"
        valid_sensors: >
          {% set temps = [
            'JV...38: ' + states('sensor.jv2279a93038_temperatura'),
            'JV...40: ' + states('sensor.jv2279a93040_temperatura'),
            'JV...41: ' + states('sensor.jv2279a93041_temperatura'),
            'JV...43: ' + states('sensor.jv2279a93043_temperatura'),
            'JV...45: ' + states('sensor.jv2279a93045_temperatura')
          ] %}
          {{ temps | select('search', '[0-9]') | list | join(', ') if temps | select('search', '[0-9]') | list | length > 0 else 'Brak aktywnych sensorÃ³w' }}

- binary_sensor:
    - name: "Bateria - bezpieczna temperatura"
      unique_id: battery_temperature_safe
      # âœ… FIXED: UÅ¼ywa prawdziwej temperatury baterii z Huawei Solar (sensor.akumulator_1_temperatura)
      # Poprzednio: JV* (optymalizatory PV na dachu 7.8Â°C) - BÅÄ„D!
      # Teraz: sensor.akumulator_1_temperatura (~31.6Â°C) - POPRAWNE!
      state: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {{ temp >= 5 and temp <= 40 }}
      icon: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {% if temp > 43 %}
          mdi:fire-alert
        {% elif temp > 40 %}
          mdi:thermometer-alert
        {% elif temp < -5 %}
          mdi:snowflake-alert
        {% elif temp < 0 %}
          mdi:thermometer-low
        {% else %}
          mdi:thermometer-check
        {% endif %}
      attributes:
        friendly_name: "Bateria - bezpieczna temperatura"
        current_temp: >
          {% set temp = states('sensor.bateria_temperatura_maksymalna') %}
          {% if temp in ['unknown', 'unavailable'] %}
            Brak danych - sprawdÅº sensory Pack temperature
          {% else %}
            {{ temp }}Â°C
          {% endif %}
        safe_range: "5-40Â°C"
        optimal_range: "15-25Â°C"
        source: "max(Pack 1/2/3 max temperature)"
        status: >
          {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
          {% if temp > 45 %}
            EKSTREMALNIE NIEBEZPIECZNE (>45Â°C)
          {% elif temp > 40 %}
            KRYTYCZNE (>40Â°C)
          {% elif temp > 35 %}
            OSTRZEÅ»ENIE (>35Â°C)
          {% elif temp < 0 %}
            ZAMARZANIE (<0Â°C)
          {% elif temp < 5 %}
            ZA ZIMNO (<5Â°C)
          {% elif temp >= 15 and temp <= 25 %}
            OPTYMALNA (15-25Â°C)
          {% else %}
            BEZPIECZNA (5-40Â°C)
          {% endif %}

# ============================================
# BILANS MOCY
# ============================================

- sensor:
    - name: "NadwyÅ¼ka PV"
      unique_id: pv_surplus
      unit_of_measurement: "kW"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) / 1000 %}
        {% set load = states('sensor.pomiar_mocy_moc_czynna') | float(0) / 1000 | abs %}
        {% set surplus = pv - load %}
        {{ [surplus, 0] | max | round(2) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "NadwyÅ¼ka energii z PV"

- sensor:
    - name: "Deficyt mocy"
      unique_id: power_deficit
      unit_of_measurement: "kW"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) / 1000 %}
        {% set load = states('sensor.pomiar_mocy_moc_czynna') | float(0) / 1000 | abs %}
        {% set deficit = load - pv %}
        {{ [deficit, 0] | max | round(2) }}
      icon: mdi:flash-alert
      attributes:
        friendly_name: "Deficyt mocy"

# ============================================
# LIMITY MOCY BATERII
# ============================================

- sensor:
    - name: "Bateria - max moc Å‚adowania"
      unique_id: battery_max_charge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_ladowania') | int(5000) }}
      icon: mdi:battery-charging-high
      attributes:
        friendly_name: "Maksymalna moc Å‚adowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"

- sensor:
    - name: "Bateria - max moc rozÅ‚adowania"
      unique_id: battery_max_discharge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_rozladowania') | int(5000) }}
      icon: mdi:battery-minus
      attributes:
        friendly_name: "Maksymalna moc rozÅ‚adowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"
        note: "0W = blokada rozÅ‚adowania (tryb L2)"

# ============================================
# SYSTEM BÅÄ˜DÃ“W I MONITORINGU
# ============================================

- sensor:
    # ===== LICZNIK BÅÄ˜DÃ“W ALGORYTMU =====
    - name: "BÅ‚Ä™dy Algorytmu - Licznik"
      unique_id: algorithm_errors_count
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {% if 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision %}
          {{ states('sensor.bledy_algorytmu_licznik') | int(0) + 1 }}
        {% else %}
          {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
        {% endif %}
      attributes:
        friendly_name: "BÅ‚Ä™dy algorytmu (dziÅ›)"
        last_error: "{{ states('input_text.battery_decision_reason') }}"
        icon: mdi:alert-circle

    # ===== OSTATNI BÅÄ„D SYSTEMU =====
    # POPRAWIONE: Pokazuje tylko PRAWDZIWE bÅ‚Ä™dy, nie normalne decyzje algorytmu
    - name: "System - Ostatni BÅ‚Ä…d"
      unique_id: system_last_error
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {% set is_algorithm_error = 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision or 'ðŸš¨' in decision %}
        {% set huawei_error = state_attr('binary_sensor.huawei_connection_status', 'last_error') %}
        {% set rce_unavailable = states('sensor.rce_pse_cena') in ['unavailable', 'unknown'] %}

        {% if is_algorithm_error %}
          {{ decision[:200] }}
        {% elif huawei_error %}
          Huawei Solar: {{ huawei_error }}
        {% elif rce_unavailable %}
          RCE PSE: niedostÄ™pny
        {% else %}
          Brak bÅ‚Ä™dÃ³w
        {% endif %}
      attributes:
        friendly_name: "Ostatni bÅ‚Ä…d systemu"
        last_decision: "{{ states('input_text.battery_decision_reason') }}"
        has_error: >
          {% set decision = states('input_text.battery_decision_reason') %}
          {{ 'BÅÄ„D' in decision or 'bÅ‚Ä…d' in decision or 'ERROR' in decision or 'ðŸš¨' in decision }}
        huawei_status: "{{ 'OK' if states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        rce_status: "{{ 'OK' if states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        icon: mdi:alert-octagon

- binary_sensor:
    # ===== STATUS SYSTEMÃ“W =====
    - name: "System - BÅ‚Ä…d Krytyczny"
      unique_id: system_critical_error
      state: >
        {% set decision = states('input_text.battery_decision_reason') %}
        {{ 'BÅÄ„D' in decision or 'ðŸš¨' in decision or 'ZATRZYMANO' in decision }}
      attributes:
        friendly_name: "BÅ‚Ä…d krytyczny w systemie"
        details: "{{ states('input_text.battery_decision_reason') }}"
        icon: mdi:alert-circle
      device_class: problem

    # ===== MONITORING INTEGRACJI =====
    - name: "Integracje - Status"
      unique_id: integrations_status
      state: >
        {% set huawei = states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] %}
        {% set rce = states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] %}
        {% set forecast = states('sensor.prognoza_pv_jutro') not in ['unavailable', 'unknown'] %}
        {{ huawei and rce and forecast }}
      attributes:
        friendly_name: "Status integracji"
        huawei_solar: "{{ 'OK' if states('sensor.akumulatory_stan_pojemnosci') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        rce_pse: "{{ 'OK' if states('sensor.rce_pse_cena') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        forecast_solar: "{{ 'OK' if states('sensor.prognoza_pv_jutro') not in ['unavailable', 'unknown'] else 'BÅÄ„D' }}"
        icon: mdi:lan-connect
      device_class: connectivity

# ============================================
# EVENT LOG - Historia zdarzeÅ„ systemowych
# ============================================

- sensor:
    # ===== PARSOWANY EVENT LOG - OSTATNIE ZDARZENIE =====
    - name: "Event Log - Ostatnie Zdarzenie"
      unique_id: event_log_latest
      state: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw != 'unknown' and raw != '' %}
          {% set event = raw | from_json %}
          {{ event.get('msg', 'Brak danych')[:50] }}
        {% else %}
          Brak zdarzeÅ„
        {% endif %}
      attributes:
        friendly_name: "Ostatnie zdarzenie"
        timestamp: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('ts', '') }}
          {% else %}
            -
          {% endif %}
        level: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('lvl', 'INFO') }}
          {% else %}
            INFO
          {% endif %}
        category: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('cat', '') }}
          {% else %}
            -
          {% endif %}
        full_message: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {{ event.get('msg', '') }}
          {% else %}
            -
          {% endif %}
        icon: >
          {% set raw = states('input_text.event_log_1') %}
          {% if raw and raw != 'unknown' %}
            {% set event = raw | from_json %}
            {% set lvl = event.get('lvl', 'INFO') %}
            {% if lvl == 'ERROR' %}mdi:alert-circle
            {% elif lvl == 'WARNING' %}mdi:alert
            {% elif lvl == 'DEBUG' %}mdi:bug
            {% else %}mdi:information
            {% endif %}
          {% else %}
            mdi:information
          {% endif %}

    # ===== HISTORIA ZDARZEÅƒ - 5 OSTATNICH =====
    - name: "Event Log - Historia"
      unique_id: event_log_history
      state: >
        {% set slots = [
          states('input_text.event_log_1'),
          states('input_text.event_log_2'),
          states('input_text.event_log_3'),
          states('input_text.event_log_4'),
          states('input_text.event_log_5')
        ] %}
        {% set valid = slots | select('ne', '') | select('ne', 'unknown') | list %}
        {% set count = 0 %}
        {% for s in valid %}
          {% set event = s | from_json %}
          {% if event.get('msg', '') != '' %}
            {% set count = count + 1 %}
          {% endif %}
        {% endfor %}
        {{ count }} zdarzeÅ„
      attributes:
        friendly_name: "Historia zdarzeÅ„ (5 ostatnich)"
        event_1: "{{ states('input_text.event_log_1') }}"
        event_2: "{{ states('input_text.event_log_2') }}"
        event_3: "{{ states('input_text.event_log_3') }}"
        event_4: "{{ states('input_text.event_log_4') }}"
        event_5: "{{ states('input_text.event_log_5') }}"
        # Statystyki per poziom (z ostatnich 5)
        errors_count: >
          {% set count = 0 %}
          {% for i in range(1, 6) %}
            {% set raw = states('input_text.event_log_' ~ i) %}
            {% if raw and raw not in ['', 'unknown'] %}
              {% set event = raw | from_json %}
              {% if event.get('lvl') == 'ERROR' %}
                {% set count = count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ count }}
        warnings_count: >
          {% set count = 0 %}
          {% for i in range(1, 6) %}
            {% set raw = states('input_text.event_log_' ~ i) %}
            {% if raw and raw not in ['', 'unknown'] %}
              {% set event = raw | from_json %}
              {% if event.get('lvl') == 'WARNING' %}
                {% set count = count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ count }}
        icon: mdi:history

    # ===== FORMATOWANA LISTA ZDARZEÅƒ (dla Markdown card) =====
    - name: "Event Log - Markdown"
      unique_id: event_log_markdown
      state: "event_log"
      attributes:
        friendly_name: "Event Log (Markdown)"
        slot_1: "{{ states('input_text.event_log_1') }}"
        slot_2: "{{ states('input_text.event_log_2') }}"
        slot_3: "{{ states('input_text.event_log_3') }}"
        slot_4: "{{ states('input_text.event_log_4') }}"
        slot_5: "{{ states('input_text.event_log_5') }}"
        icon: mdi:format-list-bulleted

# ============================================
# PLANOWANIE NOCNEGO ÅADOWANIA
# ============================================

# PV Start Hour - godzina startu produkcji PV (prÃ³g 500W)
- sensor:
    - name: "PV - Godzina startu"
      unique_id: pv_start_hour
      unit_of_measurement: "h"
      state: >
        {% set wschod_watts = state_attr('sensor.pv_wschod_prognoza_dzis', 'watts') or {} %}
        {% set poludnie_watts = state_attr('sensor.pv_poludnie_prognoza_dzis', 'watts') or {} %}
        {% set zachod_watts = state_attr('sensor.pv_zachod_prognoza_dzis', 'watts') or {} %}
        {% set tomorrow = (now().date() + timedelta(days=1)) | string %}
        {% set wschod_watts_jutro = state_attr('sensor.pv_wschod_prognoza_jutro', 'watts') or {} %}
        {% set poludnie_watts_jutro = state_attr('sensor.pv_poludnie_prognoza_jutro', 'watts') or {} %}
        {% set zachod_watts_jutro = state_attr('sensor.pv_zachod_prognoza_jutro', 'watts') or {} %}
        {% set threshold = 500 %}
        {% set pv_start = 12 %}

        {# SprawdÅº wszystkie godziny od 5 do 12 #}
        {% for h in range(5, 13) %}
          {% set time_key = tomorrow ~ ' ' ~ '%02d:00:00' | format(h) %}
          {% set w = wschod_watts_jutro.get(time_key, wschod_watts.get(time_key, 0)) | float(0) %}
          {% set p = poludnie_watts_jutro.get(time_key, poludnie_watts.get(time_key, 0)) | float(0) %}
          {% set z = zachod_watts_jutro.get(time_key, zachod_watts.get(time_key, 0)) | float(0) %}
          {% set total = w + p + z %}
          {% if total >= threshold and pv_start == 12 %}
            {% set pv_start = h %}
          {% endif %}
        {% endfor %}
        {{ pv_start }}
      icon: mdi:weather-sunset-up
      attributes:
        friendly_name: "Godzina startu PV (jutro)"
        threshold: "500W"
        description: "Pierwsza godzina z produkcjÄ… PV > 500W"

    # Nocne zuÅ¼ycie - obliczone z zapisanych wartoÅ›ci
    - name: "Nocne zuÅ¼ycie - obliczone"
      unique_id: night_consumption_calculated
      unit_of_measurement: "kWh"
      state: >
        {% set start = states('input_number.night_consumption_start') | float(0) %}
        {% set end = states('input_number.night_consumption_end') | float(0) %}
        {% if start > 0 and end > 0 and end > start %}
          {{ (end - start) | round(2) }}
        {% else %}
          {{ states('input_number.night_consumption_avg') | float(16) }}
        {% endif %}
      icon: mdi:lightning-bolt
      attributes:
        friendly_name: "ZuÅ¼ycie nocne (22:00-06:00)"
        start_value: "{{ states('input_number.night_consumption_start') }}"
        end_value: "{{ states('input_number.night_consumption_end') }}"
        avg_value: "{{ states('input_number.night_consumption_avg') }}"

    # Plan nocnego Å‚adowania - czy Å‚adowaÄ‡ baterie
    - name: "Plan nocnego Å‚adowania"
      unique_id: night_charging_plan
      state: >
        {% set soc = states('sensor.akumulatory_stan_pojemnosci') | float(50) %}
        {% set battery_kwh = 10 %}
        {% set available_kwh = (soc / 100) * battery_kwh %}
        {% set night_consumption = states('input_number.night_consumption_avg') | float(16) %}
        {% set pv_start = states('sensor.pv_godzina_startu') | int(8) %}
        {% set safety_buffer = 1 %}

        {# Oblicz godziny do startu PV od teraz #}
        {% set current_hour = now().hour %}
        {% if current_hour >= 22 %}
          {% set hours_to_pv = (24 - current_hour) + pv_start %}
        {% elif current_hour < 6 %}
          {% set hours_to_pv = pv_start - current_hour %}
        {% else %}
          {% set hours_to_pv = 0 %}
        {% endif %}

        {# ZuÅ¼ycie do startu PV (proporcja nocnego zuÅ¼ycia) #}
        {% set consumption_to_pv = (hours_to_pv / 8) * night_consumption %}

        {# Potrzebna energia = zuÅ¼ycie + bufor #}
        {% set needed_kwh = consumption_to_pv + safety_buffer %}

        {% if available_kwh >= needed_kwh %}
          NIE_ÅADUJ
        {% else %}
          ÅADUJ
        {% endif %}
      icon: >
        {% if is_state('sensor.plan_nocnego_ladowania', 'ÅADUJ') %}
          mdi:battery-charging
        {% else %}
          mdi:battery-check
        {% endif %}
      attributes:
        friendly_name: "Plan nocnego Å‚adowania"
        current_soc: "{{ states('sensor.akumulatory_stan_pojemnosci') }}%"
        available_kwh: >
          {% set soc = states('sensor.akumulatory_stan_pojemnosci') | float(50) %}
          {{ ((soc / 100) * 10) | round(2) }} kWh
        night_consumption_avg: "{{ states('input_number.night_consumption_avg') }} kWh"
        pv_start_hour: "{{ states('sensor.pv_godzina_startu') }}:00"
        safety_buffer: "1 kWh"
        decision_reason: >
          {% set soc = states('sensor.akumulatory_stan_pojemnosci') | float(50) %}
          {% set battery_kwh = 10 %}
          {% set available_kwh = (soc / 100) * battery_kwh %}
          {% set night_consumption = states('input_number.night_consumption_avg') | float(16) %}
          {% set pv_start = states('sensor.pv_godzina_startu') | int(8) %}
          {% set safety_buffer = 1 %}
          {% set current_hour = now().hour %}
          {% if current_hour >= 22 %}
            {% set hours_to_pv = (24 - current_hour) + pv_start %}
          {% elif current_hour < 6 %}
            {% set hours_to_pv = pv_start - current_hour %}
          {% else %}
            {% set hours_to_pv = 0 %}
          {% endif %}
          {% set consumption_to_pv = (hours_to_pv / 8) * night_consumption %}
          {% set needed_kwh = consumption_to_pv + safety_buffer %}
          SOC {{ soc }}% = {{ available_kwh | round(1) }} kWh, potrzeba {{ needed_kwh | round(1) }} kWh do {{ pv_start }}:00
