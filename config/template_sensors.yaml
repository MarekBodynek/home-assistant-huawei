# Template sensors dla algorytmu zarządzania baterią
# Plik generowany automatycznie przez Claude Code

# ============================================
# STREFY TARYFOWE G12w
# ============================================

- sensor:
    - name: "Strefa taryfowa"
      unique_id: tariff_zone_g12w
      state: >
        {% set h = now().hour %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if not is_workday %}
          L2
        {% elif (h >= 22) or (h < 6) %}
          L2
        {% elif (h >= 13) and (h < 15) %}
          L2
        {% else %}
          L1
        {% endif %}
      icon: mdi:clock-time-four-outline
      attributes:
        friendly_name: "Strefa taryfowa G12w"
        description: "L1 (droga) lub L2 (tania) - weekendy i święta CAŁY DZIEŃ L2!"

# ============================================
# SEZON GRZEWCZY I TEMPERATURA
# ============================================

- binary_sensor:
    - name: "Sezon grzewczy"
      unique_id: heating_season
      state: >
        {{ states('sensor.temperatura_zewnetrzna') | float(20) < 12 }}
      icon: >
        {% if is_state('binary_sensor.sezon_grzewczy', 'on') %}
          mdi:radiator
        {% else %}
          mdi:radiator-off
        {% endif %}
      attributes:
        friendly_name: "Sezon grzewczy aktywny"
        threshold: "12°C"

- binary_sensor:
    - name: "PC CO aktywne"
      unique_id: pc_co_active
      state: >
        {{ states('sensor.temperatura_zewnetrzna') | float(20) < 12 }}
      icon: mdi:heat-pump
      attributes:
        friendly_name: "Pompa ciepła - ogrzewanie aktywna"

# ============================================
# OKNA CWU (Ciepła Woda Użytkowa)
# ============================================

- binary_sensor:
    - name: "Okno CWU"
      unique_id: cwu_window
      state: >
        {% set h = now().hour %}
        {% set m = now().minute %}
        {% set time_decimal = h + (m / 60.0) %}
        {% set is_workday = is_state('binary_sensor.dzien_roboczy', 'on') %}
        {% if is_workday %}
          {{ (time_decimal >= 4.5 and time_decimal < 6) or (time_decimal >= 13 and time_decimal < 15) or (time_decimal >= 20 and time_decimal < 24) }}
        {% else %}
          {{ time_decimal >= 7 and time_decimal < 24 }}
        {% endif %}
      icon: >
        {% if is_state('binary_sensor.okno_cwu', 'on') %}
          mdi:water-boiler
        {% else %}
          mdi:water-boiler-off
        {% endif %}
      attributes:
        friendly_name: "Okno CWU aktywne"
        workday_windows: "04:30-06:00, 13:00-15:00, 20:00-23:59"
        weekend_window: "07:00-23:59"

# ============================================
# CENY ENERGII - ZAKUP (z sieci)
# ============================================

- sensor:
    - name: "Cena zakupu energii"
      unique_id: energy_buy_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ states('sensor.pstryk_current_sell_price') | float(0.65) }}
      icon: mdi:cash-multiple
      attributes:
        friendly_name: "Cena zakupu energii (RCE z Pstryk)"
        zone: "{{ states('sensor.strefa_taryfowa') }}"
        source: "Pstryk SELL prices (RCE)"
        note: "Używa cen sprzedaży = ceny RCE"

# ============================================
# CENY ENERGII - SPRZEDAŻ (do sieci)
# ============================================

- sensor:
    - name: "Cena sprzedaży energii"
      unique_id: energy_sell_price
      unit_of_measurement: "PLN/kWh"
      state: >
        {{ states('sensor.pstryk_current_sell_price') | float(0.55) }}
      icon: mdi:cash-plus
      attributes:
        friendly_name: "Cena sprzedaży energii (z Pstryk)"
        source: "Pstryk API"
        note: "Pstryk już zawiera VAT"

# ============================================
# ŚREDNIA CENA RCE WIECZORNA (19-22h)
# ============================================

- sensor:
    - name: "RCE średnia wieczorna"
      unique_id: rce_evening_average
      unit_of_measurement: "PLN/kWh"
      state: >
        {% set prices = state_attr('sensor.pstryk_current_sell_price', 'All prices') %}
        {% if prices %}
          {% set evening_prices = [] %}
          {% for p in prices %}
            {% set hour = p.start.split('T')[1].split(':')[0] | int %}
            {% if hour in [19, 20, 21] %}
              {% set evening_prices = evening_prices + [p.price] %}
            {% endif %}
          {% endfor %}
          {% if evening_prices | length > 0 %}
            {{ (evening_prices | sum / evening_prices | length) | round(3) }}
          {% else %}
            {{ states('sensor.pstryk_current_sell_price') | float(0.65) }}
          {% endif %}
        {% else %}
          {{ states('sensor.pstryk_current_sell_price') | float(0.65) }}
        {% endif %}
      icon: mdi:chart-line
      attributes:
        friendly_name: "RCE średnia wieczorna (19-22h)"
        source: "Pstryk SELL API - ceny RCE"

# ============================================
# PROGNOZA PV - POMOCNICZE SENSORY
# ============================================

- sensor:
    - name: "Prognoza PV dzisiaj"
      unique_id: forecast_pv_today
      unit_of_measurement: "kWh"
      state: >
        {{ states('sensor.energy_production_today') | float(0) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV dziś"
        source: "sensor.energy_production_today"

- sensor:
    - name: "Prognoza PV jutro"
      unique_id: forecast_pv_tomorrow
      unit_of_measurement: "kWh"
      state: >
        {{ states('sensor.energy_production_tomorrow') | float(0) | round(1) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Prognoza produkcji PV jutro"
        source: "sensor.energy_production_tomorrow"

- sensor:
    - name: "Prognoza PV 6h"
      unique_id: forecast_pv_6h
      unit_of_measurement: "kWh"
      state: >
        {% set hour = now().hour %}
        {% set wschod_hours = state_attr('sensor.energy_production_today_pv_wschod', 'wh_hours') or {} %}
        {% set poludnie_hours = state_attr('sensor.energy_production_today_pv_poludnie', 'wh_hours') or {} %}
        {% set zachod_hours = state_attr('sensor.energy_production_today_pv_zachod', 'wh_hours') or {} %}
        {% set suma = 0 %}
        {% for i in range(1, 6) %}
          {% set h = hour + i %}
          {% set w = wschod_hours[h] | default(0) | float / 1000 %}
          {% set p = poludnie_hours[h] | default(0) | float / 1000 %}
          {% set z = zachod_hours[h] | default(0) | float / 1000 %}
          {% set suma = suma + w + p + z %}
        {% endfor %}
        {{ suma | round(1) }}
      icon: mdi:solar-power-variant
      attributes:
        friendly_name: "Prognoza PV następne 6h"

# ============================================
# CEL ŁADOWANIA BATERII (Target SOC)
# ============================================

- sensor:
    - name: "Cel SOC baterii"
      unique_id: battery_target_soc
      unit_of_measurement: "%"
      state: >
        {{ states('input_number.battery_target_soc') | int(70) }}
      icon: mdi:battery-charging-80
      attributes:
        friendly_name: "Docelowy poziom naładowania baterii"
        description: "Obliczany o 04:00 przez calculate_daily_strategy()"

# ============================================
# TEMPERATURA ZEWNĘTRZNA (z integracji pogody)
# ============================================

- sensor:
    - name: "Temperatura zewnętrzna"
      unique_id: outdoor_temperature
      unit_of_measurement: "°C"
      state: >
        {{ state_attr('weather.forecast_dom', 'temperature') | float(10) }}
      icon: mdi:thermometer
      attributes:
        friendly_name: "Temperatura na zewnątrz"

# ============================================
# BEZPIECZEŃSTWO TERMICZNE BATERII
# ============================================

- sensor:
    - name: "Bateria - temperatura maksymalna"
      unique_id: battery_temperature_max
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {% set temps = [
          states('sensor.jv2279a93038_temperatura') | float(0),
          states('sensor.jv2279a93040_temperatura') | float(0),
          states('sensor.jv2279a93041_temperatura') | float(0),
          states('sensor.jv2279a93043_temperatura') | float(0),
          states('sensor.jv2279a93045_temperatura') | float(0),
          states('sensor.jv2279a93046_temperatura') | float(0),
          states('sensor.jv2279a93047_temperatura') | float(0),
          states('sensor.jv2279a93048_temperatura') | float(0),
          states('sensor.jv2279a93049_temperatura') | float(0),
          states('sensor.jv2279a93050_temperatura') | float(0),
          states('sensor.jv2279a93051_temperatura') | float(0),
          states('sensor.jv2279a93053_temperatura') | float(0),
          states('sensor.jv2279a93055_temperatura') | float(0),
          states('sensor.jv2279a93068_temperatura') | float(0),
          states('sensor.jv2279a93073_temperatura') | float(0),
          states('sensor.jv2279a93074_temperatura') | float(0),
          states('sensor.jv2279a93075_temperatura') | float(0)
        ] %}
        {% set valid_temps = temps | reject('eq', 0) | list %}
        {{ valid_temps | max if valid_temps | length > 0 else 25 }}
      icon: mdi:thermometer-high
      attributes:
        friendly_name: "Bateria - najwyższa temperatura modułu"
        valid_sensors: >
          {% set temps = [
            'JV...38: ' + states('sensor.jv2279a93038_temperatura'),
            'JV...40: ' + states('sensor.jv2279a93040_temperatura'),
            'JV...41: ' + states('sensor.jv2279a93041_temperatura'),
            'JV...43: ' + states('sensor.jv2279a93043_temperatura'),
            'JV...45: ' + states('sensor.jv2279a93045_temperatura')
          ] %}
          {{ temps | select('search', '[0-9]') | list | join(', ') if temps | select('search', '[0-9]') | list | length > 0 else 'Brak aktywnych sensorów' }}

- binary_sensor:
    - name: "Bateria - bezpieczna temperatura"
      unique_id: battery_temperature_safe
      state: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {{ temp >= 5 and temp <= 40 }}
      icon: >
        {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
        {% if temp > 43 %}
          mdi:fire-alert
        {% elif temp > 40 %}
          mdi:thermometer-alert
        {% elif temp < 0 %}
          mdi:snowflake-alert
        {% elif temp < 5 %}
          mdi:thermometer-low
        {% else %}
          mdi:thermometer-check
        {% endif %}
      attributes:
        friendly_name: "Bateria - bezpieczna temperatura"
        temperature: "{{ states('sensor.bateria_temperatura_maksymalna') }}°C"
        safe_range: "5-40°C"
        optimal_range: "15-25°C"
        status: >
          {% set temp = states('sensor.bateria_temperatura_maksymalna') | float(25) %}
          {% if temp > 45 %}
            EKSTREMALNIE NIEBEZPIECZNE (>45°C)
          {% elif temp > 43 %}
            KRYTYCZNE (>43°C)
          {% elif temp > 40 %}
            OSTRZEŻENIE (>40°C)
          {% elif temp < 0 %}
            ZAMARZANIE (<0°C)
          {% elif temp < 5 %}
            ZA ZIMNO (<5°C)
          {% elif temp >= 15 and temp <= 25 %}
            OPTYMALNA (15-25°C)
          {% else %}
            BEZPIECZNA (5-40°C)
          {% endif %}

# ============================================
# BILANS MOCY
# ============================================

- sensor:
    - name: "Nadwyżka PV"
      unique_id: pv_surplus
      unit_of_measurement: "kW"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) / 1000 %}
        {% set load = states('sensor.pomiar_mocy_moc_czynna') | float(0) / 1000 | abs %}
        {% set surplus = pv - load %}
        {{ [surplus, 0] | max | round(2) }}
      icon: mdi:solar-power
      attributes:
        friendly_name: "Nadwyżka energii z PV"

- sensor:
    - name: "Deficyt mocy"
      unique_id: power_deficit
      unit_of_measurement: "kW"
      state: >
        {% set pv = states('sensor.inwerter_moc_wejsciowa') | float(0) / 1000 %}
        {% set load = states('sensor.pomiar_mocy_moc_czynna') | float(0) / 1000 | abs %}
        {% set deficit = load - pv %}
        {{ [deficit, 0] | max | round(2) }}
      icon: mdi:flash-alert
      attributes:
        friendly_name: "Deficyt mocy"

# ============================================
# LIMITY MOCY BATERII
# ============================================

- sensor:
    - name: "Bateria - max moc ładowania"
      unique_id: battery_max_charge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_ladowania') | int(5000) }}
      icon: mdi:battery-charging-high
      attributes:
        friendly_name: "Maksymalna moc ładowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"

- sensor:
    - name: "Bateria - max moc rozładowania"
      unique_id: battery_max_discharge_power
      unit_of_measurement: "W"
      state: >
        {{ states('number.akumulatory_maksymalna_moc_rozladowania') | int(5000) }}
      icon: mdi:battery-minus
      attributes:
        friendly_name: "Maksymalna moc rozładowania baterii"
        max_spec: "5000W (Luna 2000 15kWh)"
        note: "0W = blokada rozładowania (tryb L2)"
