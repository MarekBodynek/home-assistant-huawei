# Skrypty dla Huawei Solar

# =================================================================
# SCENTRALIZOWANY SYSTEM POWIADOMIE≈É
# =================================================================
# Ten skrypt wysy≈Ça powiadomienia zar√≥wno do Telegram jak i Persistent Notifications
# z obs≈ÇugƒÖ priorytet√≥w i formatowania.
#
# Parametry:
#   - title: Tytu≈Ç powiadomienia
#   - message: Tre≈õƒá powiadomienia
#   - priority: DEBUG | INFO | WARNING | CRITICAL (domy≈õlnie INFO)
#   - notification_id: ID dla persistent notification (opcjonalne)
#
# Poziomy priorytet√≥w:
#   DEBUG    - üü¢ Raporty dzienne, szczeg√≥≈Çy techniczne
#   INFO     - üü° Standardowe informacje (≈Çadowanie, tryby)
#   WARNING  - üü† Ostrze≈ºenia (watchdog, temperature warnings)
#   CRITICAL - üî¥ Krytyczne alerty (temp >43¬∞C, SOC <5%)
# =================================================================

send_notification:
  alias: "Wy≈õlij powiadomienie (Telegram + HA)"
  description: "Scentralizowany system wysy≈Çania powiadomie≈Ñ z obs≈ÇugƒÖ priorytet√≥w"
  fields:
    title:
      description: "Tytu≈Ç powiadomienia"
      example: "üîã Bateria"
    message:
      description: "Tre≈õƒá powiadomienia"
      example: "≈Åadowanie rozpoczƒôte"
    priority:
      description: "Priorytet: DEBUG, INFO, WARNING, CRITICAL"
      example: "INFO"
      default: "INFO"
    notification_id:
      description: "ID dla persistent notification (opcjonalne)"
      example: "battery_charging"
  sequence:
    # Krok 1: Przygotowanie priorytet√≥w numerycznych dla por√≥wnania
    - variables:
        priority_value: >
          {% set priorities = {'DEBUG': 0, 'INFO': 1, 'WARNING': 2, 'CRITICAL': 3} %}
          {{ priorities.get(priority, 1) }}
        min_priority_value: >
          {% set priorities = {'DEBUG': 0, 'INFO': 1, 'WARNING': 2, 'CRITICAL': 3} %}
          {% set min_level = states('input_select.telegram_notification_level') %}
          {{ priorities.get(min_level, 1) }}

    # Krok 2: Formatowanie wiadomo≈õci wed≈Çug priorytetu
    - variables:
        formatted_message: >
          {% if priority == 'CRITICAL' %}
          üö® **{{ title }}**

          **{{ message }}**
          {% elif priority == 'WARNING' %}
          ‚ö†Ô∏è **{{ title }}**

          {{ message }}
          {% elif priority == 'DEBUG' %}
          üìä {{ title }}

          `{{ message }}`
          {% else %}
          ‚ÑπÔ∏è {{ title }}

          {{ message }}
          {% endif %}

    # Krok 3: Wys≈Çanie do Telegram (je≈õli w≈ÇƒÖczone i priority >= min_priority)
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.telegram_notifications_enabled
              state: 'on'
            - condition: template
              value_template: "{{ priority_value|int >= min_priority_value|int }}"
          sequence:
            - service: notify.telegram
              data:
                message: "{{ formatted_message }}"
                # Telegram wspiera markdown v2 formatting
                data:
                  parse_mode: markdown

    # Krok 4: Wys≈Çanie do Persistent Notification (je≈õli w≈ÇƒÖczone)
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.persistent_notifications_enabled
              state: 'on'
          sequence:
            - service: persistent_notification.create
              data:
                title: "{{ title }}"
                message: "{{ message }}"
                notification_id: "{{ notification_id if notification_id is defined else omit }}"

# =================================================================
# ORYGINALNE SKRYPTY MANUALNEGO STEROWANIA
# =================================================================

# Skrypt do rƒôcznego wymuszenia ≈Çadowania
force_battery_charge:
  alias: "Wymu≈õ ≈Çadowanie baterii"
  sequence:
    - service: huawei_solar.forcible_charge
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
        power: 5000
        duration: 60
    - service: script.send_notification
      data:
        title: "üîã Huawei Solar"
        message: "Uruchomiono rƒôczne ≈Çadowanie baterii"
        priority: "INFO"

# Skrypt do zatrzymania ≈Çadowania
stop_battery_charge:
  alias: "Zatrzymaj ≈Çadowanie baterii"
  sequence:
    - service: huawei_solar.stop_forcible_charge
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
    - service: script.send_notification
      data:
        title: "üõë Huawei Solar"
        message: "Zatrzymano ≈Çadowanie baterii"
        priority: "INFO"

# Skrypt do prze≈ÇƒÖczenia w tryb TOU (Time of Use)
enable_tou_mode:
  alias: "W≈ÇƒÖcz tryb TOU"
  sequence:
    - service: select.select_option
      data:
        entity_id: select.battery_working_mode
        option: "Time of Use"
    - service: script.send_notification
      data:
        title: "‚è∞ Huawei Solar"
        message: "W≈ÇƒÖczono tryb Time of Use"
        priority: "INFO"

# Skrypt do prze≈ÇƒÖczenia w tryb Maximise Self Consumption
enable_self_consumption:
  alias: "W≈ÇƒÖcz MaksymalnƒÖ Autoconsumpcjƒô"
  sequence:
    - service: select.select_option
      data:
        entity_id: select.battery_working_mode
        option: "Maximise Self Consumption"
    - service: script.send_notification
      data:
        title: "üè† Huawei Solar"
        message: "W≈ÇƒÖczono tryb Maksymalnej Autoconsumpcji"
        priority: "INFO"
