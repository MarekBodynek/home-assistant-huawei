# Skrypty dla Huawei Solar

# Skrypt do rÄ™cznego wymuszenia Å‚adowania
force_battery_charge:
  alias: "WymuÅ› Å‚adowanie baterii"
  sequence:
    - service: huawei_solar.forcible_charge
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
        power: 5000
        duration: 60
    - service: notify.persistent_notification
      data:
        title: "ðŸ”‹ Huawei Solar"
        message: "Uruchomiono rÄ™czne Å‚adowanie baterii"

# Skrypt do zatrzymania Å‚adowania
stop_battery_charge:
  alias: "Zatrzymaj Å‚adowanie baterii"
  sequence:
    - service: huawei_solar.stop_forcible_charge
      data:
        device_id: 450d2d6fd853d7876315d70559e1dd83
    - service: notify.persistent_notification
      data:
        title: "ðŸ›‘ Huawei Solar"
        message: "Zatrzymano Å‚adowanie baterii"

# Skrypt do przeÅ‚Ä…czenia w tryb TOU (Time of Use)
enable_tou_mode:
  alias: "WÅ‚Ä…cz tryb TOU"
  sequence:
    - service: select.select_option
      data:
        entity_id: select.battery_working_mode
        option: "Time of Use"
    - service: notify.persistent_notification
      data:
        title: "â° Huawei Solar"
        message: "WÅ‚Ä…czono tryb Time of Use"

# Skrypt do przeÅ‚Ä…czenia w tryb Maximise Self Consumption
enable_self_consumption:
  alias: "WÅ‚Ä…cz MaksymalnÄ… AutoconsumpcjÄ™"
  sequence:
    - service: select.select_option
      data:
        entity_id: select.battery_working_mode
        option: "Maximise Self Consumption"
    - service: notify.persistent_notification
      data:
        title: "ðŸ  Huawei Solar"
        message: "WÅ‚Ä…czono tryb Maksymalnej Autoconsumpcji"

# ============================================
# UNIWERSALNY SKRYPT POWIADOMIEÅƒ
# ============================================
send_notification:
  alias: "WyÅ›lij powiadomienie"
  description: "WysyÅ‚a powiadomienie przez Telegram i/lub UI w zaleÅ¼noÅ›ci od ustawieÅ„"
  fields:
    title:
      description: "TytuÅ‚ powiadomienia"
      example: "Bateria"
    message:
      description: "TreÅ›Ä‡ powiadomienia"
      example: "SOC spadÅ‚ poniÅ¼ej 20%"
    priority:
      description: "Priorytet: DEBUG, INFO, WARNING, ERROR, CRITICAL"
      example: "INFO"
  sequence:
    # Mapowanie priorytetÃ³w na liczby
    - variables:
        priority_levels:
          DEBUG: 0
          INFO: 1
          WARNING: 2
          ERROR: 3
          CRITICAL: 4
        current_priority: "{{ priority_levels[priority | default('INFO')] | default(1) | int }}"
        min_level: "{{ priority_levels[states('input_select.telegram_notification_level')] | default(1) | int }}"

    # Telegram - jeÅ›li wÅ‚Ä…czony i priorytet wystarczajÄ…cy
    - if:
        - condition: state
          entity_id: input_boolean.telegram_notifications_enabled
          state: "on"
        - condition: template
          value_template: "{{ current_priority | int >= min_level | int }}"
      then:
        - service: notify.telegram
          data:
            title: "{{ title }}"
            message: "{{ message }}"

    # Persistent notification - jeÅ›li wÅ‚Ä…czony
    - if:
        - condition: state
          entity_id: input_boolean.persistent_notifications_enabled
          state: "on"
      then:
        - service: persistent_notification.create
          data:
            title: "{{ title }}"
            message: "{{ message }}"
