# ============================================
# AUTOMATIONS - POWIADOMIENIA O BÅÄ˜DACH
# ============================================
# Automatyczne powiadomienia o bÅ‚Ä™dach krytycznych i ostrzeÅ¼eniach

# ===== BÅÄ„D KRYTYCZNY - NATYCHMIASTOWE POWIADOMIENIE =====
- alias: "[BÅÄ„D] Krytyczny bÅ‚Ä…d systemu"
  id: critical_error_notification
  description: "Powiadomienie o bÅ‚Ä™dzie krytycznym algorytmu lub systemu"
  trigger:
    - platform: state
      entity_id: binary_sensor.system_blad_krytyczny
      to: "on"
  action:
    # Telegram - zawsze przy bÅ‚Ä™dzie krytycznym
    - service: notify.telegram
      data:
        title: "ðŸš¨ BÅÄ„D KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto bÅ‚Ä…d krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
          **SOC:** {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          **Temp:** {{ states('sensor.bateria_temperatura_maksymalna') }}Â°C

    # Persistent notification - teÅ¼
    - service: persistent_notification.create
      data:
        title: "ðŸš¨ BÅÄ„D KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto bÅ‚Ä…d krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

          **Status systemÃ³w:**
          - Bateria SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Åadowanie: {{ states('switch.akumulatory_ladowanie_z_sieci') }}
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}Â°C
        notification_id: "critical_error"

# ===== INTEGRACJA OFFLINE - OSTRZEÅ»ENIE =====
- alias: "[OSTRZEÅ»ENIE] Integracja offline"
  id: integration_offline_warning
  description: "Powiadomienie gdy integracja (Huawei/RCE PSE/Forecast) przestaje dziaÅ‚aÄ‡"
  trigger:
    - platform: state
      entity_id: binary_sensor.integracje_status
      to: "off"
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    # Telegram - jeÅ›li wÅ‚Ä…czony
    - service: notify.telegram
      data:
        title: "âš ï¸ Integracja offline"
        message: |
          Jedna lub wiÄ™cej integracji nie dziaÅ‚a!

          Huawei: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          Forecast: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

    # Persistent notification
    - service: persistent_notification.create
      data:
        title: "âš ï¸ OSTRZEÅ»ENIE: Integracja offline"
        message: |
          **Jedna lub wiÄ™cej integracji nie dziaÅ‚a!**

          **Status:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        notification_id: "integration_offline"

# ===== BÅÄ„D ALGORYTMU - LOG =====
- alias: "[LOG] BÅ‚Ä…d algorytmu baterii"
  description: "Loguj bÅ‚Ä™dy algorytmu do pliku"
  trigger:
    - platform: state
      entity_id: input_text.battery_decision_reason
  condition:
    - condition: template
      value_template: >
        {{ 'BÅÄ„D' in states('input_text.battery_decision_reason') or
           'bÅ‚Ä…d' in states('input_text.battery_decision_reason') or
           'ERROR' in states('input_text.battery_decision_reason') }}
  action:
    - service: system_log.write
      data:
        message: "BÅÄ„D ALGORYTMU: {{ states('input_text.battery_decision_reason') }}"
        level: error
        logger: homeassistant.components.python_script

# ===== RESET LICZNIKA BÅÄ˜DÃ“W O PÃ“ÅNOCY =====
- alias: "[SYSTEM] Reset licznika bÅ‚Ä™dÃ³w"
  description: "Resetuj licznik bÅ‚Ä™dÃ³w o pÃ³Å‚nocy"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.error_counter
      data:
        value: 0

# ===== TEMPERATURA BATERII - FAÅSZYWY ALARM =====
- alias: "[INFO] Temperatura baterii - faÅ‚szywy alarm"
  description: "Loguj informacjÄ™ o faÅ‚szywym alarmie temperatury (sensory JV* = optymalizatory PV)"
  trigger:
    - platform: state
      entity_id: binary_sensor.bateria_bezpieczna_temperatura
      to: "off"
  action:
    - service: system_log.write
      data:
        message: >
          INFO: Temperatura baterii poza zakresem ({{ states('sensor.bateria_temperatura_maksymalna') }}Â°C).
          UWAGA: To moÅ¼e byÄ‡ faÅ‚szywy alarm - sensor uÅ¼ywa temp. optymalizatorÃ³w PV (dach).
          Prawdziwa temp. baterii w FusionSolar: ~31Â°C.
        level: info
        logger: homeassistant.components.template

# ===== RAPORT DZIENNY - PODSUMOWANIE BÅÄ˜DÃ“W =====
- alias: "[RAPORT] Dzienny raport bÅ‚Ä™dÃ³w"
  description: "Codzienny raport bÅ‚Ä™dÃ³w o 23:55"
  trigger:
    - platform: time
      at: "23:55:00"
  action:
    - service: persistent_notification.create
      data:
        title: "ðŸ“Š Raport dzienny - BÅ‚Ä™dy systemu"
        message: |
          **Podsumowanie za {{ now().strftime('%Y-%m-%d') }}**

          **BÅ‚Ä™dy algorytmu:** {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
          **Ostatni bÅ‚Ä…d:** {{ states('sensor.system_ostatni_blad') }}

          **Status integracji:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Status baterii:**
          - SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}Â°C
          - BezpieczeÅ„stwo: {{ 'OK' if states('binary_sensor.bateria_bezpieczna_temperatura') == 'on' else 'ALARM' }}
        notification_id: "daily_error_report"

# ============================================
# EVENT LOG - System logowania zdarzeÅ„
# ============================================

# ===== EVENT LOG: Telegram alert dla ERROR =====
- alias: "[EVENT LOG] Telegram alert - bÅ‚Ä…d"
  id: event_log_telegram_error
  description: "WyÅ›lij powiadomienie Telegram gdy Event Log zawiera ERROR"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'ERROR' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    - service: notify.telegram
      data:
        title: "ðŸš¨ BÅÄ„D SYSTEMU"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'ERROR') }}]** {{ event.get('msg', 'BÅ‚Ä…d') }}

          ðŸ• {{ event.get('ts', '')[:16] | replace('T', ' ') }}
          ðŸ”‹ SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%

# ===== EVENT LOG: Telegram alert dla WARNING =====
- alias: "[EVENT LOG] Telegram alert - ostrzeÅ¼enie"
  id: event_log_telegram_warning
  description: "WyÅ›lij powiadomienie Telegram gdy Event Log zawiera WARNING"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'WARNING' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
    - condition: template
      value_template: >
        {{ states('input_select.telegram_notification_level') in ['DEBUG', 'INFO', 'WARNING'] }}
  action:
    - service: notify.telegram
      data:
        title: "âš ï¸ OSTRZEÅ»ENIE"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'WARNING') }}]** {{ event.get('msg', 'OstrzeÅ¼enie') }}

          ðŸ• {{ event.get('ts', '')[:16] | replace('T', ' ') }}

# ===== TELEGRAM: Status po zmianie taryfy (06:03, 13:03, 15:03, 22:03) =====
- alias: "[TELEGRAM] Status po zmianie taryfy"
  id: telegram_tariff_change_status
  description: "WyÅ›lij status baterii 3 min po zmianie taryfy (niezaleÅ¼nie od poziomu)"
  trigger:
    - platform: time
      at: "06:03:00"
    - platform: time
      at: "13:03:00"
    - platform: time
      at: "15:03:00"
    - platform: time
      at: "22:03:00"
  condition:
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    - service: notify.telegram
      data:
        title: "ðŸ”‹ STATUS PO ZMIANIE TARYFY"
        message: >
          **Strefa: {{ states('sensor.strefa_taryfowa') }}** ({{ now().strftime('%H:%M') }})

          {{ states('input_text.battery_decision_reason') }}

          ðŸ”‹ SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          ðŸ’° RCE: {{ ((states('sensor.rce_pse_cena') | float(0)) / 1000) | round(2) }} zÅ‚/kWh
          ðŸŒ¡ï¸ Temp: {{ states('sensor.temperatura_zewnetrzna') }}Â°C

# ===== EVENT LOG: Loguj waÅ¼ne zdarzenia do pliku =====
- alias: "[EVENT LOG] System log - waÅ¼ne zdarzenia"
  id: event_log_system_log
  description: "Loguj ERROR i WARNING do system_log"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') in ['ERROR', 'WARNING'] }}
        {% else %}
          false
        {% endif %}
  action:
    - service: system_log.write
      data:
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          [EVENT LOG][{{ event.get('lvl') }}][{{ event.get('cat') }}] {{ event.get('msg') }}
        level: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          {{ event.get('lvl', 'info') | lower }}
        logger: homeassistant.components.event_log

# ===== EVENT LOG: Reset slotÃ³w o pÃ³Å‚nocy (opcjonalnie) =====
- alias: "[EVENT LOG] Reset dzienny"
  id: event_log_daily_reset
  description: "Reset Event Log o pÃ³Å‚nocy (zachowuje ostatnie zdarzenie)"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    # Zachowaj slot 1 jako "ostatnie zdarzenie z poprzedniego dnia"
    # Reset slotÃ³w 2-5
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'

# ===== EVENT LOG: Manualny wpis (do testowania) =====
- alias: "[EVENT LOG] Manualny wpis testowy"
  id: event_log_manual_test
  description: "Skrypt do manualnego dodania wpisu testowego (uruchom przez Developer Tools)"
  trigger: []
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: "{{ states('input_text.event_log_4') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: "{{ states('input_text.event_log_3') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: "{{ states('input_text.event_log_2') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: "{{ states('input_text.event_log_1') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_1
      data:
        value: '{"ts":"{{ now().strftime("%Y-%m-%dT%H:%M:%S") }}","lvl":"INFO","cat":"TEST","msg":"Testowy wpis Event Log"}'

# ============================================
# AWARIA SIECI - BACKUP MODE
# ============================================

# ===== AWARIA SIECI - URUCHOM ALGORYTM =====
- alias: "[KRYTYCZNE] Awaria sieci - backup mode"
  id: krytyczne_awaria_sieci_backup_mode
  description: "Uruchom algorytm baterii gdy wykryto brak napiÄ™cia w sieci"
  trigger:
    - platform: state
      entity_id: binary_sensor.awaria_sieci
      to: "on"
  action:
    # Natychmiast uruchom algorytm baterii (przejmie kontrolÄ™)
    - service: python_script.battery_algorithm
  mode: single

# ===== SIEÄ† PRZYWRÃ“CONA - URUCHOM ALGORYTM =====
- alias: "[INFO] SieÄ‡ przywrÃ³cona"
  id: info_siec_przywrocona
  description: "Uruchom algorytm baterii gdy sieÄ‡ wrÃ³ciÅ‚a"
  trigger:
    - platform: state
      entity_id: binary_sensor.awaria_sieci
      from: "on"
      to: "off"
  action:
    # Uruchom algorytm Å¼eby przywrÃ³ciÄ‡ normalny tryb
    - delay:
        seconds: 10
    - service: python_script.battery_algorithm
  mode: single
