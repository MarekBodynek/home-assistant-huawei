# ============================================
# AUTOMATIONS - POWIADOMIENIA O B≈ÅƒòDACH
# ============================================
# Automatyczne powiadomienia o b≈Çƒôdach krytycznych i ostrze≈ºeniach

# ===== B≈ÅƒÑD KRYTYCZNY - NATYCHMIASTOWE POWIADOMIENIE =====
- alias: "[B≈ÅƒÑD] Krytyczny b≈ÇƒÖd systemu"
  id: critical_error_notification
  description: "Powiadomienie o b≈Çƒôdzie krytycznym algorytmu lub systemu"
  trigger:
    - platform: state
      entity_id: binary_sensor.system_blad_krytyczny
      to: "on"
  action:
    # Telegram - zawsze przy b≈Çƒôdzie krytycznym
    - service: notify.telegram
      data:
        title: "üö® B≈ÅƒÑD KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto b≈ÇƒÖd krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
          **SOC:** {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          **Temp:** {{ states('sensor.bateria_temperatura_maksymalna') }}¬∞C

    # Persistent notification - te≈º
    - service: persistent_notification.create
      data:
        title: "üö® B≈ÅƒÑD KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto b≈ÇƒÖd krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

          **Status system√≥w:**
          - Bateria SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - ≈Åadowanie: {{ states('switch.akumulatory_ladowanie_z_sieci') }}
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}¬∞C
        notification_id: "critical_error"

# ===== INTEGRACJA OFFLINE - OSTRZE≈ªENIE =====
- alias: "[OSTRZE≈ªENIE] Integracja offline"
  id: integration_offline_warning
  description: "Powiadomienie gdy integracja (Huawei/RCE PSE/Forecast) przestaje dzia≈Çaƒá"
  trigger:
    - platform: state
      entity_id: binary_sensor.integracje_status
      to: "off"
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    # Telegram - je≈õli w≈ÇƒÖczony
    - service: notify.telegram
      data:
        title: "‚ö†Ô∏è Integracja offline"
        message: |
          Jedna lub wiƒôcej integracji nie dzia≈Ça!

          Huawei: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          Forecast: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

    # Persistent notification
    - service: persistent_notification.create
      data:
        title: "‚ö†Ô∏è OSTRZE≈ªENIE: Integracja offline"
        message: |
          **Jedna lub wiƒôcej integracji nie dzia≈Ça!**

          **Status:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        notification_id: "integration_offline"

# ===== B≈ÅƒÑD ALGORYTMU - LOG =====
- alias: "[LOG] B≈ÇƒÖd algorytmu baterii"
  description: "Loguj b≈Çƒôdy algorytmu do pliku"
  trigger:
    - platform: state
      entity_id: input_text.battery_decision_reason
  condition:
    - condition: template
      value_template: >
        {{ 'B≈ÅƒÑD' in states('input_text.battery_decision_reason') or
           'b≈ÇƒÖd' in states('input_text.battery_decision_reason') or
           'ERROR' in states('input_text.battery_decision_reason') }}
  action:
    - service: system_log.write
      data:
        message: "B≈ÅƒÑD ALGORYTMU: {{ states('input_text.battery_decision_reason') }}"
        level: error
        logger: homeassistant.components.python_script

# ===== RESET LICZNIKA B≈ÅƒòD√ìW O P√ì≈ÅNOCY =====
- alias: "[SYSTEM] Reset licznika b≈Çƒôd√≥w"
  description: "Resetuj licznik b≈Çƒôd√≥w o p√≥≈Çnocy"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.error_counter
      data:
        value: 0

# ===== TEMPERATURA BATERII - FA≈ÅSZYWY ALARM =====
- alias: "[INFO] Temperatura baterii - fa≈Çszywy alarm"
  description: "Loguj informacjƒô o fa≈Çszywym alarmie temperatury (sensory JV* = optymalizatory PV)"
  trigger:
    - platform: state
      entity_id: binary_sensor.bateria_bezpieczna_temperatura
      to: "off"
  action:
    - service: system_log.write
      data:
        message: >
          INFO: Temperatura baterii poza zakresem ({{ states('sensor.bateria_temperatura_maksymalna') }}¬∞C).
          UWAGA: To mo≈ºe byƒá fa≈Çszywy alarm - sensor u≈ºywa temp. optymalizator√≥w PV (dach).
          Prawdziwa temp. baterii w FusionSolar: ~31¬∞C.
        level: info
        logger: homeassistant.components.template

# ===== RAPORT DZIENNY - PODSUMOWANIE B≈ÅƒòD√ìW =====
- alias: "[RAPORT] Dzienny raport b≈Çƒôd√≥w"
  description: "Codzienny raport b≈Çƒôd√≥w o 23:55"
  trigger:
    - platform: time
      at: "23:55:00"
  action:
    - service: persistent_notification.create
      data:
        title: "üìä Raport dzienny - B≈Çƒôdy systemu"
        message: |
          **Podsumowanie za {{ now().strftime('%Y-%m-%d') }}**

          **B≈Çƒôdy algorytmu:** {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
          **Ostatni b≈ÇƒÖd:** {{ states('sensor.system_ostatni_blad') }}

          **Status integracji:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Status baterii:**
          - SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}¬∞C
          - Bezpiecze≈Ñstwo: {{ 'OK' if states('binary_sensor.bateria_bezpieczna_temperatura') == 'on' else 'ALARM' }}
        notification_id: "daily_error_report"

# ============================================
# EVENT LOG - System logowania zdarze≈Ñ
# ============================================

# ===== EVENT LOG: Telegram alert dla ERROR =====
- alias: "[EVENT LOG] Telegram alert - b≈ÇƒÖd"
  id: event_log_telegram_error
  description: "Wy≈õlij powiadomienie Telegram gdy Event Log zawiera ERROR"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'ERROR' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    - service: notify.telegram
      data:
        title: "üö® B≈ÅƒÑD SYSTEMU"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'ERROR') }}]** {{ event.get('msg', 'B≈ÇƒÖd') }}

          üïê {{ event.get('ts', '')[:16] | replace('T', ' ') }}
          üîã SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%

# ===== EVENT LOG: Telegram alert dla WARNING =====
- alias: "[EVENT LOG] Telegram alert - ostrze≈ºenie"
  id: event_log_telegram_warning
  description: "Wy≈õlij powiadomienie Telegram gdy Event Log zawiera WARNING"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'WARNING' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
    - condition: template
      value_template: >
        {{ states('input_select.telegram_notification_level') in ['DEBUG', 'INFO', 'WARNING'] }}
  action:
    - service: notify.telegram
      data:
        title: "‚ö†Ô∏è OSTRZE≈ªENIE"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'WARNING') }}]** {{ event.get('msg', 'Ostrze≈ºenie') }}

          üïê {{ event.get('ts', '')[:16] | replace('T', ' ') }}

# ===== EVENT LOG: Loguj wa≈ºne zdarzenia do pliku =====
- alias: "[EVENT LOG] System log - wa≈ºne zdarzenia"
  id: event_log_system_log
  description: "Loguj ERROR i WARNING do system_log"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') in ['ERROR', 'WARNING'] }}
        {% else %}
          false
        {% endif %}
  action:
    - service: system_log.write
      data:
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          [EVENT LOG][{{ event.get('lvl') }}][{{ event.get('cat') }}] {{ event.get('msg') }}
        level: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          {{ event.get('lvl', 'info') | lower }}
        logger: homeassistant.components.event_log

# ===== EVENT LOG: Reset slot√≥w o p√≥≈Çnocy (opcjonalnie) =====
- alias: "[EVENT LOG] Reset dzienny"
  id: event_log_daily_reset
  description: "Reset Event Log o p√≥≈Çnocy (zachowuje ostatnie zdarzenie)"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    # Zachowaj slot 1 jako "ostatnie zdarzenie z poprzedniego dnia"
    # Reset slot√≥w 2-5
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'

# ===== EVENT LOG: Manualny wpis (do testowania) =====
- alias: "[EVENT LOG] Manualny wpis testowy"
  id: event_log_manual_test
  description: "Skrypt do manualnego dodania wpisu testowego (uruchom przez Developer Tools)"
  trigger: []
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: "{{ states('input_text.event_log_4') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: "{{ states('input_text.event_log_3') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: "{{ states('input_text.event_log_2') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: "{{ states('input_text.event_log_1') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_1
      data:
        value: '{"ts":"{{ now().strftime("%Y-%m-%dT%H:%M:%S") }}","lvl":"INFO","cat":"TEST","msg":"Testowy wpis Event Log"}'
