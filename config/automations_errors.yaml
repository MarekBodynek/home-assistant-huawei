# ============================================
# AUTOMATIONS - POWIADOMIENIA O BDACH
# ============================================
# Automatyczne powiadomienia o bdach krytycznych i ostrze偶eniach

# ===== BD KRYTYCZNY - NATYCHMIASTOWE POWIADOMIENIE =====
- alias: "[BD] Krytyczny bd systemu"
  description: "Powiadomienie o bdzie krytycznym algorytmu lub systemu"
  trigger:
    - platform: state
      entity_id: binary_sensor.system_blad_krytyczny
      to: "on"
  action:
    - service: script.send_notification
      data:
        title: " BD KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto bd krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

          **Status system贸w:**
          - Bateria SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - adowanie: {{ states('switch.akumulatory_ladowanie_z_sieci') }}
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}掳C
        priority: "CRITICAL"
        notification_id: "critical_error"

# ===== INTEGRACJA OFFLINE - OSTRZE呕ENIE =====
- alias: "[OSTRZE呕ENIE] Integracja offline"
  description: "Powiadomienie gdy integracja (Huawei/Pstryk/Forecast) przestaje dziaa"
  trigger:
    - platform: state
      entity_id: binary_sensor.integracje_status
      to: "off"
      for:
        minutes: 5
  action:
    - service: script.send_notification
      data:
        title: "锔 OSTRZE呕ENIE: Integracja offline"
        message: |
          **Jedna lub wicej integracji nie dziaa!**

          **Status:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - Pstryk RCE: {{ state_attr('binary_sensor.integracje_status', 'pstryk_rce') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        priority: "WARNING"
        notification_id: "integration_offline"

# ===== BD ALGORYTMU - LOG =====
- alias: "[LOG] Bd algorytmu baterii"
  description: "Loguj bdy algorytmu do pliku"
  trigger:
    - platform: state
      entity_id: input_text.battery_decision_reason
  condition:
    - condition: template
      value_template: >
        {{ 'BD' in states('input_text.battery_decision_reason') or
           'bd' in states('input_text.battery_decision_reason') or
           'ERROR' in states('input_text.battery_decision_reason') }}
  action:
    - service: system_log.write
      data:
        message: "BD ALGORYTMU: {{ states('input_text.battery_decision_reason') }}"
        level: error
        logger: homeassistant.components.python_script

# ===== RESET LICZNIKA BDW O PNOCY =====
- alias: "[SYSTEM] Reset licznika bd贸w"
  description: "Resetuj licznik bd贸w o p贸nocy"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.error_counter
      data:
        value: 0

# ===== TEMPERATURA BATERII - FASZYWY ALARM =====
- alias: "[INFO] Temperatura baterii - faszywy alarm"
  description: "Loguj informacj o faszywym alarmie temperatury (sensory JV* = optymalizatory PV)"
  trigger:
    - platform: state
      entity_id: binary_sensor.bateria_bezpieczna_temperatura
      to: "off"
  action:
    - service: system_log.write
      data:
        message: >
          INFO: Temperatura baterii poza zakresem ({{ states('sensor.bateria_temperatura_maksymalna') }}掳C).
          UWAGA: To mo偶e by faszywy alarm - sensor u偶ywa temp. optymalizator贸w PV (dach).
          Prawdziwa temp. baterii w FusionSolar: ~31掳C.
        level: info
        logger: homeassistant.components.template

# ===== RAPORT DZIENNY - PODSUMOWANIE BDW =====
- alias: "[RAPORT] Dzienny raport bd贸w"
  description: "Codzienny raport bd贸w o 23:55"
  trigger:
    - platform: time
      at: "23:55:00"
  action:
    - service: script.send_notification
      data:
        title: " Raport dzienny - Bdy systemu"
        message: |
          **Podsumowanie za {{ now().strftime('%Y-%m-%d') }}**

          **Bdy algorytmu:** {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
          **Ostatni bd:** {{ states('sensor.system_ostatni_blad') }}

          **Status integracji:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - Pstryk RCE: {{ state_attr('binary_sensor.integracje_status', 'pstryk_rce') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Status baterii:**
          - SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}掳C
          - Bezpieczestwo: {{ 'OK' if states('binary_sensor.bateria_bezpieczna_temperatura') == 'on' else 'ALARM' }}
        priority: "DEBUG"
        notification_id: "daily_error_report"
