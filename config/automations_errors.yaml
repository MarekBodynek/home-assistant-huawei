# ============================================
# AUTOMATIONS - POWIADOMIENIA O BDACH
# ============================================
# Automatyczne powiadomienia o bdach krytycznych i ostrze偶eniach

# ===== BD KRYTYCZNY - NATYCHMIASTOWE POWIADOMIENIE =====
- alias: "[BD] Krytyczny bd systemu"
  description: "Powiadomienie o bdzie krytycznym algorytmu lub systemu"
  trigger:
    - platform: state
      entity_id: binary_sensor.system_blad_krytyczny
      to: "on"
  action:
    - service: persistent_notification.create
      data:
        title: " BD KRYTYCZNY SYSTEMU"
        message: |
          **Wykryto bd krytyczny!**

          {{ states('input_text.battery_decision_reason') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

          **Status system贸w:**
          - Bateria SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - adowanie: {{ states('switch.akumulatory_ladowanie_z_sieci') }}
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}掳C
        notification_id: "critical_error"

# ===== INTEGRACJA OFFLINE - OSTRZE呕ENIE =====
- alias: "[OSTRZE呕ENIE] Integracja offline"
  description: "Powiadomienie gdy integracja (Huawei/RCE PSE/Forecast) przestaje dziaa"
  trigger:
    - platform: state
      entity_id: binary_sensor.integracje_status
      to: "off"
      for:
        minutes: 5
  action:
    - service: persistent_notification.create
      data:
        title: "锔 OSTRZE呕ENIE: Integracja offline"
        message: |
          **Jedna lub wicej integracji nie dziaa!**

          **Status:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Czas:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        notification_id: "integration_offline"

# ===== BD ALGORYTMU - LOG =====
- alias: "[LOG] Bd algorytmu baterii"
  description: "Loguj bdy algorytmu do pliku"
  trigger:
    - platform: state
      entity_id: input_text.battery_decision_reason
  condition:
    - condition: template
      value_template: >
        {{ 'BD' in states('input_text.battery_decision_reason') or
           'bd' in states('input_text.battery_decision_reason') or
           'ERROR' in states('input_text.battery_decision_reason') }}
  action:
    - service: system_log.write
      data:
        message: "BD ALGORYTMU: {{ states('input_text.battery_decision_reason') }}"
        level: error
        logger: homeassistant.components.python_script

# ===== RESET LICZNIKA BDW O PNOCY =====
- alias: "[SYSTEM] Reset licznika bd贸w"
  description: "Resetuj licznik bd贸w o p贸nocy"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.error_counter
      data:
        value: 0

# ===== TEMPERATURA BATERII - FASZYWY ALARM =====
- alias: "[INFO] Temperatura baterii - faszywy alarm"
  description: "Loguj informacj o faszywym alarmie temperatury (sensory JV* = optymalizatory PV)"
  trigger:
    - platform: state
      entity_id: binary_sensor.bateria_bezpieczna_temperatura
      to: "off"
  action:
    - service: system_log.write
      data:
        message: >
          INFO: Temperatura baterii poza zakresem ({{ states('sensor.bateria_temperatura_maksymalna') }}掳C).
          UWAGA: To mo偶e by faszywy alarm - sensor u偶ywa temp. optymalizator贸w PV (dach).
          Prawdziwa temp. baterii w FusionSolar: ~31掳C.
        level: info
        logger: homeassistant.components.template

# ===== RAPORT DZIENNY - PODSUMOWANIE BDW =====
- alias: "[RAPORT] Dzienny raport bd贸w"
  description: "Codzienny raport bd贸w o 23:55"
  trigger:
    - platform: time
      at: "23:55:00"
  action:
    - service: persistent_notification.create
      data:
        title: " Raport dzienny - Bdy systemu"
        message: |
          **Podsumowanie za {{ now().strftime('%Y-%m-%d') }}**

          **Bdy algorytmu:** {{ states('sensor.bledy_algorytmu_licznik') | int(0) }}
          **Ostatni bd:** {{ states('sensor.system_ostatni_blad') }}

          **Status integracji:**
          - Huawei Solar: {{ state_attr('binary_sensor.integracje_status', 'huawei_solar') }}
          - RCE PSE: {{ state_attr('binary_sensor.integracje_status', 'rce_pse') }}
          - Forecast.Solar: {{ state_attr('binary_sensor.integracje_status', 'forecast_solar') }}

          **Status baterii:**
          - SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%
          - Temperatura: {{ states('sensor.bateria_temperatura_maksymalna') }}掳C
          - Bezpieczestwo: {{ 'OK' if states('binary_sensor.bateria_bezpieczna_temperatura') == 'on' else 'ALARM' }}
        notification_id: "daily_error_report"

# ============================================
# EVENT LOG - System logowania zdarze
# ============================================

# ===== EVENT LOG: Telegram alert dla ERROR =====
- alias: "[EVENT LOG] Telegram alert - bd"
  id: event_log_telegram_error
  description: "Wylij powiadomienie Telegram gdy Event Log zawiera ERROR"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'ERROR' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
  action:
    - service: notify.telegram
      data:
        title: " BD SYSTEMU"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'ERROR') }}]** {{ event.get('msg', 'Bd') }}

           {{ event.get('ts', '')[:16] | replace('T', ' ') }}
           SOC: {{ states('sensor.akumulatory_stan_pojemnosci') }}%

# ===== EVENT LOG: Telegram alert dla WARNING =====
- alias: "[EVENT LOG] Telegram alert - ostrze偶enie"
  id: event_log_telegram_warning
  description: "Wylij powiadomienie Telegram gdy Event Log zawiera WARNING"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') == 'WARNING' }}
        {% else %}
          false
        {% endif %}
    - condition: state
      entity_id: input_boolean.telegram_notifications_enabled
      state: "on"
    - condition: template
      value_template: >
        {{ states('input_select.telegram_notification_level') in ['DEBUG', 'INFO', 'WARNING'] }}
  action:
    - service: notify.telegram
      data:
        title: "锔 OSTRZE呕ENIE"
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          **[{{ event.get('cat', 'WARNING') }}]** {{ event.get('msg', 'Ostrze偶enie') }}

           {{ event.get('ts', '')[:16] | replace('T', ' ') }}

# ===== EVENT LOG: Loguj wa偶ne zdarzenia do pliku =====
- alias: "[EVENT LOG] System log - wa偶ne zdarzenia"
  id: event_log_system_log
  description: "Loguj ERROR i WARNING do system_log"
  trigger:
    - platform: state
      entity_id: input_text.event_log_1
  condition:
    - condition: template
      value_template: >
        {% set raw = states('input_text.event_log_1') %}
        {% if raw and raw not in ['', 'unknown'] %}
          {% set event = raw | from_json %}
          {{ event.get('lvl') in ['ERROR', 'WARNING'] }}
        {% else %}
          false
        {% endif %}
  action:
    - service: system_log.write
      data:
        message: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          [EVENT LOG][{{ event.get('lvl') }}][{{ event.get('cat') }}] {{ event.get('msg') }}
        level: >
          {% set raw = states('input_text.event_log_1') %}
          {% set event = raw | from_json %}
          {{ event.get('lvl', 'info') | lower }}
        logger: homeassistant.components.event_log

# ===== EVENT LOG: Reset slot贸w o p贸nocy (opcjonalnie) =====
- alias: "[EVENT LOG] Reset dzienny"
  id: event_log_daily_reset
  description: "Reset Event Log o p贸nocy (zachowuje ostatnie zdarzenie)"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    # Zachowaj slot 1 jako "ostatnie zdarzenie z poprzedniego dnia"
    # Reset slot贸w 2-5
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: '{"ts":"","lvl":"","cat":"","msg":""}'

# ===== EVENT LOG: Manualny wpis (do testowania) =====
- alias: "[EVENT LOG] Manualny wpis testowy"
  id: event_log_manual_test
  description: "Skrypt do manualnego dodania wpisu testowego (uruchom przez Developer Tools)"
  trigger: []
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_5
      data:
        value: "{{ states('input_text.event_log_4') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_4
      data:
        value: "{{ states('input_text.event_log_3') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_3
      data:
        value: "{{ states('input_text.event_log_2') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_2
      data:
        value: "{{ states('input_text.event_log_1') }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.event_log_1
      data:
        value: '{"ts":"{{ now().strftime("%Y-%m-%dT%H:%M:%S") }}","lvl":"INFO","cat":"TEST","msg":"Testowy wpis Event Log"}'
